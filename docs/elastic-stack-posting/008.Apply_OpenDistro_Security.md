# 008. OpenDistro Security ì ìš©í•˜ê¸°

OpenDistroëŠ” Elasticsearchì™€ Kibanaë¥¼ ìœ„í•œ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤. ê·¸ ì¤‘ ì£¼ìš” ê¸°ëŠ¥ì— ëŒ€í•´ì„œ ìš”ì•½í•˜ì—¬ ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

1. Security : Elasticsearchì™€ Kibanaì˜ ë³´ì•ˆì„ ê°•í™”í•˜ëŠ” ê¸°ëŠ¥ ì œê³µ
2. Alerting : Elasticsearchì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°ì§€í•˜ê³  ì•Œë¦¼ì„ ìƒì„±í•˜ëŠ” ê¸°ëŠ¥ ì œê³µ
3. Anomaly Detection : Elaticsearchì—ì„œ ë¹„ì •ìƒì ì¸ ë°ì´í„° íŒ¨í„´ì„ ê°ì§€í•˜ì—¬ ì´ìƒ ì§•í›„ë¥¼ ì‹ë³„í•˜ëŠ” ê¸°ëŠ¥ ì œê³µ
4. SQL : SQL ë¬¸ì„ ì‚¬ìš©í•˜ì—¬ Elasticsearch ë°ì´í„°ë¥¼ ì¿¼ë¦¬í•˜ê³  ë¶„ì„í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ ì œê³µ
5. Index Management : Elasticsearch ì¸ë±ìŠ¤ì˜ ìƒì„±, ìŠ¤ëƒ…ìƒ·, ì‚­ì œ ë“±ì„ ìë™ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ê¸°ëŠ¥ ì œê³µ
6. Performance : Elasticsearchì˜ ì„±ëŠ¥ì„ ë¶„ì„í•˜ê³  ëª¨ë‹ˆí„°ë§ í•˜ëŠ” ê¸°ëŠ¥ ì œê³µ
7. KNN : K-Nearest Neighbors ì•Œê³ ë¦¬ì¦˜ì„ ì§€ì›í•˜ì—¬ Elasticsearch ë°ì´í„°ì— ëŒ€í•œ ìœ ì‚¬ì„± ê²€ìƒ‰ ê¸°ëŠ¥ ì œê³µ

ì´ ì™¸ì—ë„ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì œê³µí•˜ë©°, ê¶ê¸ˆí•˜ì‹œë‹¤ë©´ [ê³µì‹ ë¬¸ì„œ](https://opendistro.github.io/for-elasticsearch-docs/)ë¥¼ ì°¸ê³ í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤.

## 00. ì‹¤ìŠµ í™˜ê²½

Apache 2.0 License ë‚´ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ë§Œ í¬í•¨ëœ OSS ë²„ì „ì„ í™œìš©í•˜ì—¬ ì‹¤ìŠµí•˜ì˜€ìŠµë‹ˆë‹¤.

- CentOS 7.9
- Elasticsearch OSS 7.10.2
- Logstash OSS 7.10.2
- Kibana OSS 7.10.2
- opendistro_security 1.13.1.0
- opendistroSecurityKibana 1.13.0.1
- OpenSSL 1.0.2
- Java 11

ë³¸ ê²Œì‹œê¸€ì—ëŠ” Elastic Stack êµ¬ì¶• ë°©ë²• ë° Java 11 ì„¤ì¹˜ì— ëŒ€í•œ ì„¤ëª…ì€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.

## 01. OpenSSLë¡œ ì¸ì¦ì„œ ìƒì„±í•˜ê¸°

::: tip

ì¸ì¦ì„œ ìƒì„±ì€ **í•˜ë‚˜ì˜ ì„œë²„ì—ì„œ ì§„í–‰**í•˜ë©´ ë©ë‹ˆë‹¤. ë™ì¼í•œ ì¸ì¦ì„œë¥¼ ê°€ì§€ê³  ìˆì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì—, í•˜ë‚˜ì˜ ì„œë²„ì—ì„œ ìƒì„±í•œ ë‹¤ìŒ ë‹¤ë¥¸ ì„œë²„ì— ë³µì‚¬í•´ì•¼ í•©ë‹ˆë‹¤.

:::

ì¸ì¦ì„œ ìƒì„±ì„ ìœ„í•´ OpenSSLì„ ì„¤ì¹˜í•©ë‹ˆë‹¤. ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì„¤ì¹˜í•œ OpenSSLì€ 1.0.2 ë²„ì „ì…ë‹ˆë‹¤.

```bash
sudo yum install openssl
```

ê·¸ ë‹¤ìŒ ì¸ì¦ì„œë¥¼ ì €ì¥í•  ë””ë ‰í„°ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```bash
sudo mkdir /etc/elasticsearch/certificates
```

ì´ì œ í•„ìš”í•œ ì¸ì¦ì„œë¥¼ ìˆœì„œëŒ€ë¡œ ìƒì„±í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

ë¨¼ì € **Root CA ì¸ì¦ì„œ**ë¥¼ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤. ì¸ì¦ì„œë¥¼ ìƒì„±í•  ë•ŒëŠ” ì•„ë˜ì™€ ê°™ì´ ê°œì¸í‚¤ë¥¼ ë¨¼ì € ìƒì„±í•œ ë‹¤ìŒ ì¸ì¦ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```bash
# í‚¤ ìƒì„±
sudo openssl genrsa -out /etc/elasticsearch/certificates/root-ca-key.pem 2048
# ì¸ì¦ì„œ ìš”ì²­ (CSR) ìƒì„±
sudo openssl req -new -x509 -sha256 -key /etc/elasticsearch/certificates/root-ca-key.pem -subj "/C=KR/ST=Seoul/L=Gangnam-gu/O=monitoring/OU=monitoring/CN=root" -out /etc/elasticsearch/certificates/root-ca.pem -days 3650
```

- `openssl genrsa` : RSA ê°œì¸í‚¤ë¥¼ ìƒì„±í•˜ëŠ” ëª…ë ¹ì–´. `root-ca-key.pem` íŒŒì¼ì— 2048 ë¹„íŠ¸ ê¸¸ì´ì˜ RSA ê°œì¸í‚¤ê°€ ìƒì„±ë¨
- `openssl req` : ì¸ì¦ì„œ ìš”ì²­(CSR, Certificates Signing Request)ì„ ìƒì„±í•˜ëŠ” ëª…ë ¹ì–´
  - `-new` : ìƒˆ ì¸ì¦ì„œ ìš”ì²­ì„ ìƒì„±í•¨ì„ ì˜ë¯¸
  - `-x509` : ìì²´ ì„œëª…ëœ `X.509` ì¸ì¦ì„œë¥¼ ìƒì„±í•¨ì„ ì˜ë¯¸
  - `-key` : ê°œì¸í‚¤ íŒŒì¼
  - `-subj` : ì¸ì¦ì„œ ìƒì„¸ ì •ë³´. (í•„ìˆ˜ X)
    - `C` : Country Name. êµ­ê°€ë¥¼ 2ìë¦¬ ì½”ë“œë¡œ ì…ë ¥í•˜ë©°, ëŒ€ë¬¸ìë¡œ í‘œê¸°í•´ì•¼ í•¨
    - `ST` : State or Province Name. ì‹œ/ë„ ì…ë ¥. e.g. ì„œìš¸ì‹œ, ê²½ê¸°ë„
    - `L` : Locality Name. êµ¬/êµ° ì…ë ¥. e.g. ê°•ë‚¨êµ¬, ìš©ì¸ì‹œ
    - `O` : Organization Name. íšŒì‚¬/ê¸°ê´€ëª…. ê°œì¸ì€ ì´ë¦„ ë˜ëŠ” ì‚¬ì´íŠ¸ëª…
    - `OU` : Organizational Unit Name (OU). íšŒì‚¬/ê¸°ê´€ ë‚´ ì¡°ì§
    - `CN` : Common Name. ì¸ì¦ì„œ ê³ ìœ  ì´ë¦„
    - `E` : Email Address. ì´ë©”ì¼ (í•„ìˆ˜ X)
  - `-out` : ìƒì„±ëœ ì¸ì¦ì„œë¥¼ ì €ì¥í•  íŒŒì¼
  - `-days` : ì¸ì¦ì„œ ìœ íš¨ ê¸°ê°„. ì—¬ê¸°ì„œëŠ” 10ë…„.

ê·¸ ë‹¤ìŒìœ¼ë¡œ ê´€ë¦¬ ê¶Œí•œì„ ê°€ì§„ Client ì¸ì¦ì„œì¸ **Admin ì¸ì¦ì„œ**ë¥¼ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤.

```bash
# í‚¤ ìƒì„±
sudo openssl genrsa -out /etc/elasticsearch/certificates/admin-key-temp.pem 2048
# ê°œì¸í‚¤ë¥¼ PKCS8ë¡œ ë³€í™˜
sudo openssl pkcs8 -inform PEM -outform PEM -in /etc/elasticsearch/certificates/admin-key-temp.pem -topk8 -nocrypt -v1 PBE-SHA1-3DES -out /etc/elasticsearch/certificates/admin-key.pem
# ì¸ì¦ì„œ ìš”ì²­ (CSR) ìƒì„±
sudo openssl req -new -key /etc/elasticsearch/certificates/admin-key.pem -subj "/C=KR/ST=Seoul/L=Gangnam-gu/O=monitoring/OU=monitoring/CN=admin" -out /etc/elasticsearch/certificates/admin.csr
# ì¸ì¦ì„œ ìƒì„±
sudo openssl x509 -req -in /etc/elasticsearch/certificates/admin.csr -CA /etc/elasticsearch/certificates/root-ca.pem -CAkey /etc/elasticsearch/certificates/root-ca-key.pem -CAcreateserial -sha256 -out /etc/elasticsearch/certificates/admin.pem -days 3650
```

`openssl genrsa`ì™€ `openssl req`ì— ëŒ€í•œ ë‚´ìš©ì€ Root CA ì¸ì¦ì„œì™€ ë™ì¼í•˜ë©°, ê·¸ ì™¸ ëª…ë ¹ì–´ì— ëŒ€í•œ ì„¤ëª…ë§Œ ê°„ëµíˆ ìš”ì•½í•´ë‘ì—ˆìŠµë‹ˆë‹¤.

- `openssl pkcs8` : ê°œì¸í‚¤ë¥¼ PKCS8 í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ëª…ë ¹ì–´
  - `-inform PEM` : ì…ë ¥ í˜•ì‹ì„ PEMìœ¼ë¡œ ì§€ì •
  - `-outform PEM` : ì¶œë ¥ í˜•ì‹ì„ PEMìœ¼ë¡œ ì§€ì •
  - `-in` : ê¸°ì¡´ RSA ê°œì¸í‚¤
  - `-topk8` : ê°œì¸í‚¤ë¥¼ PKCS8ë¡œ ë³€í™˜
  - `-nocypt` : ê°œì¸í‚¤ë¥¼ ì•”í˜¸í™”í•˜ì§€ ì•Šë„ë¡ ì§€ì •
  - `-v1 PBE-SHA1-3DES` : 
  - `-out` : ë³€í™˜ëœ ê°œì¸í‚¤ë¥¼ ì €ì¥í•  íŒŒì¼
- `openssl x509` : ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ëŠ” ëª…ë ¹ì–´
  - `-req` : ì¸ì¦ì„œ ìš”ì²­ (CSR)ì„ ì…ë ¥ìœ¼ë¡œ ë°›ëŠ”ë‹¤ëŠ” ì˜ë¯¸
  - `-in` : CSR íŒŒì¼
  - `-CA` : Root CA ì¸ì¦ì„œ
  - `-CAKey` : Root CA ê°œì¸í‚¤
  - `-CAcreateserial` : ì¼ë ¨ë²ˆí˜¸ íŒŒì¼ì„ ìƒì„±í•˜ë„ë¡ ì§€ì •
  - `-sha256` : í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ ì§€ì •
  - `-out` : ìƒì„±ëœ ì¸ì¦ì„œë¥¼ ì €ì¥í•  íŒŒì¼ ì§€ì •
  - `-days` : ì¸ì¦ì„œ ìœ íš¨ ê¸°ê°„. ì—¬ê¸°ì„œëŠ” 10ë…„.

ê·¸ë¦¬ê³  Elasticsearchì˜ ê° ë…¸ë“œì—ì„œ ì‚¬ìš©í•  **Node ì¸ì¦ì„œ**ë„ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤. node ì¸ì¦ì„œëŠ” í•„ìš”í•œ ê°œìˆ˜ë§Œí¼ ì´ë¦„ì„ ë‹¤ë¥´ê²Œ ì„¤ì •í•˜ì—¬ ìƒì„±í•˜ë©´ ë©ë‹ˆë‹¤. ì €ëŠ” `node-1`ë¶€í„° `node-5`ê¹Œì§€ 5ê°œì˜ ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

```bash
# í‚¤ ìƒì„±
sudo openssl genrsa -out /etc/elasticsearch/certificates/node-1-key-temp.pem 2048
# ê°œì¸í‚¤ë¥¼ PKCS8ë¡œ ë³€í™˜
sudo openssl pkcs8 -inform PEM -outform PEM -in /etc/elasticsearch/certificates/node-1-key-temp.pem -topk8 -nocrypt -v1 PBE-SHA1-3DES -out /etc/elasticsearch/certificates/node-1-key.pem
# ì¸ì¦ì„œ ìš”ì²­ (CSR) ìƒì„±
sudo openssl req -new -key /etc/elasticsearch/certificates/node-1-key.pem -subj "/C=KR/ST=Seoul/L=Gangnam-gu/O=monitoring/OU=monitoring/CN=node-1" -out /etc/elasticsearch/certificates/node-1.csr
# ì¸ì¦ì„œ ìƒì„±
sudo openssl x509 -req -in /etc/elasticsearch/certificates/node-1.csr -CA /etc/elasticsearch/certificates/root-ca.pem -CAkey /etc/elasticsearch/certificates/root-ca-key.pem -CAcreateserial -sha256 -out /etc/elasticsearch/certificates/node-1.pem -days 3650
```

ëª¨ë‘ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ë´…ì‹œë‹¤.

```bash
sudo ls /etc/elasticsearch/certificates
```

ê·¸ëŸ¬ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì¸ì¦ì„œë“¤ì´ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/54d08081-b55b-48c3-a57d-a40b411fbd87)

ì´ì œ ì¸ì¦ì„œ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ, ìƒì„±í•œ ì¸ì¦ì„œë¥¼ Elasticsearch ë‹¤ë¥¸ ì„œë²„ì™€ Kibana ì„œë²„ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.

## 02. Elasticsaerchì— ì ìš©í•˜ê¸°

### OpenDistro í”ŒëŸ¬ê·¸ì¸ ì„¤ì •

Elasticsearchì— OpenDistroë¥¼ ì„¤ì¹˜í•˜ê¸° ì „, Elasticsearchì˜ ëª¨ë“  ë…¸ë“œë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤.

```bash
sudo systemctl stop elasticsearch
```

ê·¸ ë‹¤ìŒ, Elasticsearch ê° ì„œë²„ì— OpenDistro Security í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜í•©ë‹ˆë‹¤.

ì €ëŠ” Windows 10 ì„œë²„ì—ì„œ [opensearch-project security Github](https://github.com/opensearch-project/security/releases/tag/v1.13.1.0)ì— ì ‘ì†í•˜ì—¬ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œ ë°›ì€ ë‹¤ìŒ, ì„œë²„ì— ì—…ë¡œë“œí•˜ì˜€ìŠµë‹ˆë‹¤. ê·¸ ë‹¤ìŒ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì¹˜í•˜ì˜€ìŠµë‹ˆë‹¤.

```bash
sudo /usr/share/elasticsearch/bin/elasticsearch-plugin install file:///home/monitoring/opendistro-security-1.13.1.0.zip
```

ì—¬ê¸°ì„œ `/usr/share/elasticsearch/bin`ì€ ì¼ë°˜ì ìœ¼ë¡œ CentOSì—ì„œ `elasticsearch-plugin`ì´ ì¡´ì¬í•˜ëŠ” ìœ„ì¹˜ì´ë©°, `file://` ë’¤ì— ìˆëŠ” `/home/monitoring/opendistro-security-1.13.1.0.zip`ì€ ì„¤ì¹˜í•˜ë ¤ëŠ” OpenDistro Security íŒŒì¼ì˜ ìœ„ì¹˜ ë° zip íŒŒì¼ì…ë‹ˆë‹¤.

ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ìŒ ê·¸ë¦¼ê³¼ ê°™ì€ ë¬¸êµ¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©°, `Continue with installation? [y/N]`ì— ëŒ€í•´ `y`ë¥¼ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/636f45bc-a092-45c5-a8d2-d932cf3f7ea6)

ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆë‹¤ë©´, `/etc/elasticsearch/elasticsearch.yml` íŒŒì¼ì— OpenDistro ì„¤ì •ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
ì•„ë˜ ë‚´ìš©ì€ `node-1` ì„œë²„ì—ì„œ ì„¤ì •í•œ ë‚´ìš©ì…ë‹ˆë‹¤.

```yaml
opendistro_security.ssl.transport.pemcert_filepath: certificates/node-1.pem
opendistro_security.ssl.transport.pemkey_filepath: certificates/node-1-key.pem
opendistro_security.ssl.transport.pemtrustedcas_filepath: certificates/root-ca.pem
opendistro_security.ssl.transport.enforce_hostname_verification: false
opendistro_security.ssl.http.pemcert_filepath: certificates/node-1.pem
opendistro_security.ssl.http.pemkey_filepath: certificates/node-1-key.pem
opendistro_security.ssl.http.pemtrustedcas_filepath: certificates/root-ca.pem
opendistro_security.nodes_dn:
  - "CN=node-1,OU=monitoring,O=monitoring,L=Gangnam-gu,ST=Seoul,C=KR"
  - "CN=node-2,OU=monitoring,O=monitoring,L=Gangnam-gu,ST=Seoul,C=KR"
  - "CN=node-3,OU=monitoring,O=monitoring,L=Gangnam-gu,ST=Seoul,C=KR"
  - "CN=node-4,OU=monitoring,O=monitoring,L=Gangnam-gu,ST=Seoul,C=KR"
  - "CN=node-5,OU=monitoring,O=monitoring,L=Gangnam-gu,ST=Seoul,C=KR"
opendistro_security.allow_default_init_securityindex: true
opendistro_security.authcz.admin_dn:
  - "CN=admin,OU=monitoring,O=monitoring,L=Gangnam-gu,ST=Seoul,C=KR"
opendistro_security.restapi.roles_enabled: ["all_access", "security_rest_api_access"]
```

ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ Elasticsearchë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
sudo systemctl start elasticsearch
```

### OpenDistro Config ì„¤ì •

OpenDistro ì„¤ì • íŒŒì¼ì€ `/usr/share/elasticsearch/plugins/opendistro_security/securityconfig` ë””ë ‰í„°ë¦¬ì— ìˆìŠµë‹ˆë‹¤. ë””ë ‰í„°ë¦¬ ë‚´ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ íŒŒì¼ì´ ì¡´ì¬í•˜ë©°, ì´ë¥¼ í™œìš©í•˜ì—¬ OpenDistro ì„¤ì •ì„ í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ì°¸ê³ ë¡œ, `elasticsearch.yml` ë‚´ì— ì¸ì¦ì„œ ê²½ë¡œ ì…ë ¥ ì‹œ, ëª¨ë‘ **ìƒëŒ€ ê²½ë¡œ**ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.

- `action_groups.yml` : action group ì´ë¼ëŠ” ê¶Œí•œ(permission)ëª¨ìŒì— ëŒ€í•œ ì„¤ì • íŒŒì¼
- `audit.yml` : ê°ì‚¬(audit) ë¡œê¹… ì„¤ì • íŒŒì¼
- `config.yml` : OpenDistro ì‚¬ìš©ì ìê²© ì¦ëª…ì„ ìœ„í•œ ì„¤ì • íŒŒì¼
- `elasticsearch.yml.example` : elasticsearch ì„¤ì • ì˜ˆì œ íŒŒì¼
- `internal_users.yml` : internal user databaseì— ì‚¬ìš©ì ë° í•´ì‹œë¡œ ë³€í™˜í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ëŠ” íŒŒì¼
- `nodes_dn.yml` : í†µì‹ ì„ í•˜ë ¤ëŠ” ë…¸ë“œ ë° í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ì„¤ì • íŒŒì¼
- `roles_mapping.yml` : ì‚¬ìš©ì, í˜¸ìŠ¤íŠ¸ ë“±ì„ ì—­í• ì— ë§¤í•‘í•˜ê¸° ìœ„í•œ íŒŒì¼
- `roles.yml` : ì—­í•  ë° ê´€ë ¨ ê¶Œí•œì— ëŒ€í•œ ì„¤ì • íŒŒì¼
- `tenants.yml` : ëŒ€ì‹œë³´ë“œ tenantë¥¼ ì§€ì •í•˜ëŠ” íŒŒì¼
- `whitelist.yml` : í—ˆìš©ëœ ì—”ë“œí¬ì¸íŠ¸ ë° ìš”ì²­ ëª©ë¡ ì„¤ì • íŒŒì¼

ë¨¼ì € `config.yml`ì„ ì„¤ì •í•˜ê² ìŠµë‹ˆë‹¤. `config.yml`ì˜ ê¸°ë³¸ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```yaml
sg_config:
  dynamic:
    http:
      anonymous_auth_enable: false
      ...
    authc: ...
    authz: ...
```

ì´ ì¤‘ `authc` ì„¤ì • ì¤‘ í•˜ë‚˜ì¸ `basic_internal_auth_domain`ë¥¼ í†µí•´ ë‚´ë¶€ ì‚¬ìš©ì ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„¤ì •í•˜ê² ìŠµë‹ˆë‹¤. ~~ì‚¬ì‹¤ ì²˜ìŒ config.ymlì„ ì—´ë©´ basic_internal_auth_domainì„ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •ë˜ì–´ ìˆì–´ íŠ¹ë³„íˆ ë³€ê²½í•  ë‚´ìš©ì€ ì—†ìŠµë‹ˆë‹¤.~~

```yaml
_meta:
  type: "config"
  config_version: 2

config:
  dynamic:
    http:
      anonymous_auth_enabled: false
      xff:
        enabled: false
    authc:
      basic_internal_auth_domain:
        description: "Authenticate via HTTP Basic against internal users database"
        http_enabled: true
        transport_enabled: true
        order: 4
        http_authenticator:
          type: basic
          challenge: true
        authentication_backend:
          type: intern
```

`roles.yml`ê³¼ `roles_mapping.yml`ì˜ ê¸°ë³¸ ì„¤ì •ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©°, `internal_user.yml`ì„ í†µí•´ ì‚¬ìš©ìì— ëŒ€í•œ ì„¤ì •ì„ í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ê·¸ ì „ì— ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •ì„ ìœ„í•´ `/usr/share/elasticsearch/plugins/opendistro_security/tools` ë””ë ‰í„°ë¦¬ì˜ `hash.sh`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹œë¡œ ë³€í™˜í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

`tools` ë””ë ‰í„°ë¦¬ë¡œ ì´ë™í•œ ë‹¤ìŒ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ì—¬ í•´ì‹œë¡œ ë³€í™˜í•©ë‹ˆë‹¤. ì´ ë•Œ, `<new-password>`ì— ì›í•˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.

```bash
. hash.sh -p <new-password>
```

íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•˜ê³  ì‹¶ë‹¤ë©´ ë°±ìŠ¬ë˜ìŠ¤(`\`)ë¥¼ ì•ì— ë¶™ì—¬ì£¼ë©´ ë©ë‹ˆë‹¤.

```bash
. hash.sh -p test\!\@
```

ì°¸ê³ ë¡œ, [BCrypt ë³€í™˜ ì‚¬ì´íŠ¸](https://bcrypt-generator.com/)ë¥¼ í†µí•´ í•´ì‹œë¥¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

í•´ì‹œë¡œ ë³€í™˜í•œ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ì¤€ë¹„ë¥¼ ì™„ë£Œí–ˆë‹¤ë©´, `securityconfig` ë””ë ‰í„°ë¦¬ë¡œ ì´ë™í•˜ì—¬ `internal_user.yml`ì„ ì„¤ì •í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```yaml
admin:
  hash: "{password}"
  reserved: true
  backend_roles:
  - "admin"
  description: "admin user"

kibanaserver:
  hash: "{password}"
  reserved: true
  description: "kibanaserver user"

logstash:
  hash: "{password}"
  reserved: false
  backend_roles:
  - "logstash"
  description: "logstash user"

readall:
  hash: "{password}"
  reserved: false
  backend_roles:
  - "readall"
  description: "readall user"

snapshot:
  hash: "{password}"
  reserved: false
  backend_roles:
  - "snapshotrestore"
  description: "snapshotrestore user"
```

ì„¤ì •í•œ ë‚´ìš©ì´ ì ìš©ë˜ë„ë¡ `securityadmin.sh`ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ `tools` ë””ë ‰í„°ë¦¬ë¡œ ì´ë™í•©ë‹ˆë‹¤.
ê·¸ ë‹¤ìŒ, `securityadmin.sh`ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œì„ ë³€ê²½í•©ë‹ˆë‹¤.

```bash
chmod +x securityadmin.sh
```

ê¶ŒíŒì„ ë³€ê²½í•˜ì˜€ìœ¼ë©´, `securityadmin.sh`ë¥¼ ì‹¤í–‰í•˜ì—¬ êµ¬ì„±ì„ ì ìš©í•©ë‹ˆë‹¤.

```bash
sudo ./securityadmin.sh -cd ../securityconfig/ -icl -nhnv -cacert /etc/elasticsearch/certificates/root-ca.pem -cert /etc/elasticsearch/certificates/admin.pem -key /etc/elasticsearch/certificates/admin-key.pem
```

- `cacert` : root PEM íŒŒì¼ ì…ë ¥
- `cert` : `admin` ê¶Œí•œì„ ê°€ì§„ PEM íŒŒì¼ ì…ë ¥
- `key` : `admin` ê¶Œí•œì„ ê°€ì§„ KEY íŒŒì¼ ì…ë ¥

ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ `curl` í˜¸ì¶œì„ í†µí•´ í™•ì¸í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```bash
curl -k -u admin:<user_password> -X GET "localhost:9200"

#e.g.
curl -k -u admin:pass1\! -X GET "localhost:9200"
```

ì°¸ê³ ë¡œ, `https://`ë¥¼ ë¶™ì—¬ í˜¸ì¶œí•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•˜ê¸°ë„ í•©ë‹ˆë‹¤.

```bash
curl: (35) SSL received a record that exceeded the maximum permissible length.
```

## 03. Kibanaì— ì ìš©í•˜ê¸°

OpenDistro Security ì ìš©ì„ ìœ„í•´ Kibanaì— í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜í•©ë‹ˆë‹¤. ì €ëŠ” Windows 10 ì„œë²„ì—ì„œ [opensearch-project security-dashboards-plugin Github](https://github.com/opensearch-project/security-dashboards-plugin/releases/tag/v1.13.0.1)ì— ì ‘ì†í•˜ì—¬ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œ ë°›ì€ ë‹¤ìŒ, ì„œë²„ì— ì—…ë¡œë“œí•˜ì˜€ìŠµë‹ˆë‹¤. ê·¸ ë‹¤ìŒ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì¹˜í•˜ì˜€ìŠµë‹ˆë‹¤.

```bash
sudo /usr/share/kibana/bin/kibana-plugin install file:///home/monitoring/opendistroSecurityKibana-7.10.2.zip --allow-root
```

ê·¸ë¦¬ê³  ì´ì „ì— ë§Œë“¤ì—ˆë˜ `certificates`ì„ `kibana.yml`ì´ ì¡´ì¬í•˜ëŠ” ë””ë ‰í„°ë¦¬ì— ì¶”ê°€í•©ë‹ˆë‹¤. íŒŒì¼ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```markdown
etc
â”œâ”€ certificates
â”‚ â”œâ”€ admin.key
â”‚ â”œâ”€ admin.pem
â”‚ â”œâ”€ root-ca.key
â”‚ â””â”€ root-ca.pem
â”œâ”€ kibana.yml
â””â”€ node.options
```

ê·¸ ë‹¤ìŒ, `kibana.yml`ì„ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•˜ì—¬ OpenDistroë¥¼ ì ìš©í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```yaml
# kibana default setting
elasticsearch.hosts: ["http://10.0.0.1:9200", "http://10.0.0.2:9200", "http://10.0.0.3:9200", "https://10.0.0.4:9200", "http://10.0.0.5:9200"]
elasticsearch.username: "kibanaserver"
elasticsearch.password: "password"
elasticsearch.ssl.certificateAuthorities: "/etc/kibana/certificates/root-ca.pem"
elasticsearch.ssl.verificationMode: full
# opendistro security setting
elasticsearch.requestHeadersWhitelist: ["securitytenant","Authorization"]
opendistro_security.multitenancy.enabled: true
opendistro_security.multitenancy.tenants.enable_global: true
opendistro_security.multitenancy.tenants.enable_private: true
opendistro_security.multitenancy.tenants.preferred: ["Private", "Global"]
opendistro_security.multitenancy.enable_filter: false
```

- `elasticsearch.hosts` : Elasticsearch host ì…ë ¥
- `elasticsearch.username` : `kibana_server` ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìì— ëŒ€í•œ ì´ë¦„
- `elasticsearch.password` : `kibana_server` ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìì— ëŒ€í•œ password
- `elasticsearch.ssl.certificateAuthorities` : Root CA ì¸ì¦ì„œ ì „ì²´ ê²½ë¡œ ì…ë ¥. ì¸ì¦ì„œ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•˜ì§€ ì•Šì„ ì‹œ, ë¯¸ì…ë ¥
- `elasticsearch.ssl.verificationMode: full` : ì¸ì¦ì„œ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•˜ë„ë¡ `full`ë¡œ ì„¤ì •. ì¸ì¦ì„œ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•˜ì§€ ì•Šì„ ì‹œ, `none`ìœ¼ë¡œ ì…ë ¥
- `elasticsearch.requestHeadersWhitelist` : Elasticsearchì— ì „ë‹¬í•´ì•¼ í•˜ëŠ” ëª¨ë“  HTTP í—¤ë” ì…ë ¥.  multi-tenancy ì‚¬ìš© ì‹œ,  "securitytenant","Authorization" ì…ë ¥ í•„ìš”
- `opendistro_security.multitenancy.enabled` : multi-tenancy í™œì„±í™” ì—¬ë¶€
- `opendistro_security.multitenancy.tenants.enable_global` : global tenancy í™œì„±í™” ì—¬ë¶€
- `opendistro_security.multitenancy.tenants.enable_private` : private tenancy í™œì„±í™” ì—¬ë¶€
- `opendistro_security.multitenancy.tenants.preferred` : tenant íƒ­ ìˆœì„œ ì„¤ì •. default ì„¤ì •ì€ global, private ë‹¤ìŒë¶€í„°ëŠ” ì•ŒíŒŒë²³ ìˆœì„œ.
- `opendistro_security.multitenancy.enable_filter` : tenant ëª©ë¡ ìƒë‹¨ ê²€ìƒ‰ë°” ì¶”ê°€ ì—¬ë¶€

ì„¤ì •ì„ ì™„ë£Œí•˜ì˜€ìœ¼ë©´, Kibanaë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
sudo systemctl start kibana
```

ê·¸ ë‹¤ìŒ 5061 í¬íŠ¸ë¥¼ í†µí•´ ì ‘ì†í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë¡œê·¸ì¸ í˜ì´ì§€ê°€ ëœ¨ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/40b5f356-ae6a-4db3-8f1a-a73c5ca49c18)

ë§Œì•½, opendistro brand imageê°€ í‘œì¶œë˜ì§€ ì•Šì•˜ìœ¼ë©´ í•˜ëŠ” ê²½ìš°, ì•„ë˜ì™€ ê°™ì€ ì„¤ì •ì„ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.

```yaml
opendistro_security.basicauth.login.showbrandimage: false
```

ì„¤ì •ì„ ì¶”ê°€í•œ ë‹¤ìŒ Kibanaë¥¼ `restart` í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ opendistro brand imageê°€ í‘œì¶œë˜ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ ì™¸ì—ì„œ ë‹¤ë¥¸ ë¡œê³ ë¥¼ ì¶”ê°€í•œë‹¤ê±°ë‚˜ ë¬¸êµ¬ë¥¼ ë°”ê¿€ ìˆ˜ë„ ìˆëŠ”ë°, ì—¬ê¸°ì„œëŠ” ì´ëŸ¬í•œ ë‚´ìš©ì€ ìƒëµí•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/0d18ef82-a53d-4663-b47b-8f211002a377)

## 04. Logstash ì„¤ì •í•˜ê¸°

OpenDistroë¥¼ í†µí•´ ìƒì„±í•œ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸ì„ í•˜ê¸° ìœ„í•´ ë¨¼ì € ì´ì „ì— ë§Œë“¤ì—ˆë˜ `root-ca.pem`ì„ `/etc/logstash` ë””ë ‰í„°ë¦¬ì— ì¶”ê°€í•©ë‹ˆë‹¤. íŒŒì¼ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

ê·¸ ë‹¤ìŒ logstash ì„¤ì • íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆë„ë¡ `pipelines.yml`ì„ ì„¤ì •í•©ë‹ˆë‹¤.

```yaml
- pipeline.id: main
  path.config: "/etc/logstash/conf.d/main.conf"
```

ê·¸ë¦¬ê³  `main.conf`ë¥¼ ìƒì„±í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ ë‚´ìš©ì„ ì…ë ¥í•©ë‹ˆë‹¤. `input.log`ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì„ì˜ë¡œ êµ¬ì„±í•œ íŒŒì¼ì´ë©°, ì„¤ì •ê³¼ ê´€ë ¨ëœ ìƒì„¸í•œ ì„¤ëª…ì€ ìƒëµí•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```bash
input {
  file {
    path => "/etc/logstash/test/input.log"
		start_position => "beginning"
		sincedb_path => "/dev/null"
	}
}

output {
  elasticsearch {
    hosts => ["http://10.0.0.1:9200", "http://10.0.0.2:9200", "http://10.0.0.3:9200", "http://10.0.0.4:9200", "http://10.0.0.5:9200"]
    index => "opendistrotest"
    user => "logstash"
    password => "logstash_password"
    ssl => true
    cacert => "/etc/logstash/root-ca.pem" # Elasticsearch path
  }
}
```

ì„¤ì •ì„ ì™„ë£Œí•œ ë‹¤ìŒ logstashë¥¼ ì¬ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
sudo systemctl restart logstash
```

`opendistrotest` ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•˜ì˜€ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ Kibanaì˜ `DevTools`ì— ì ‘ì†í•˜ì—¬ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ë´…ì‹œë‹¤.

```bash
GET _cat/indices?v
```

ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ `opendistro`ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/26fba9f4-a519-47ed-9720-09f1bcdb9064)

ì–´ë–»ê²Œ ëœ ê²ƒì¸ì§€ ì•Œì•„ë³´ê¸° ìœ„í•´, `/var/log/logstash/logstash-plain.log`ë¥¼ ì—´ì–´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë¡œê·¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```log
retrying failed action with response code: 403 ({"type"=>"security_exception", "reason"=>"no permissions for [indices:admin/create] and User [name=logstash, backend_roles=[logstash], requestedTenant=null]"})
Retrying individual bulk actions that failed or were rejected by the previous bulk request. {:count=>4}
```

ê¶Œí•œ ë¶€ì¡±ìœ¼ë¡œ ë°œìƒí•œ ì—ëŸ¬ì´ë©°, í•´ë‹¹ ì—ëŸ¬ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ `logstash` ê¸°ë³¸ ì„¤ì •ì´ ì–´ë–»ê²Œ ë˜ì–´ìˆëŠ”ì§€ í™•ì¸ì„ í•´ë´…ì‹œë‹¤. ë¨¼ì €, Kibana ë©”ë‰´ì˜ `Open Distro for Elasticsearch > Security`ë¡œ ì´ë™í•©ë‹ˆë‹¤. ì°¸ê³ ë¡œ, admin ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìë§Œ ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/f2b716d3-1d8b-4f34-8f50-4e0488eb19eb)

ê·¸ ë‹¤ìŒ `Roles` ë©”ë‰´ë¡œ ì´ë™í•˜ì—¬ `logstash`ë¥¼ ê²€ìƒ‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ í™”ë©´ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/a488a189-4f64-40ef-8c43-f6f7dc2215ac)

ì—¬ê¸°ì„œ `logstash`ë¼ëŠ” `Role`ì„ ì„ íƒí•˜ì—¬ ì„¤ì •ì„ í™•ì¸í•´ë³´ë©´, `logstash-*` ì¸ë±ìŠ¤ì™€ `*beat*` ì¸ë±ìŠ¤ì— ëŒ€í•œ ê¶Œí•œë§Œ ê°€ì§€ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/4a4022ed-4acd-4b87-9fa1-2d8b29d3e6d5)

`logstash`ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” ì—­í• ì´ê¸°ì— ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ `Duplicate role`ì„ í†µí•´ ìƒˆë¡œìš´ `logstash` ì„¤ì •ì„ ìƒì„±í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ì„¤ì •ì€ ì•„ë˜ ì´ë¯¸ì§€ì™€ ê°™ì´ í–ˆìŠµë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/fbbc6028-4157-49b3-8e47-576dcf9548fa)

- Name : custom_logstash
- Cluster permissions : ê¸°ì¡´ ì„¤ì • ìœ ì§€
- Index permissions :
  - Index : ì¸ë±ìŠ¤ íŒ¨í„´. ì—¬ê¸°ì„œëŠ” ëª¨ë‘ í—ˆìš©í•˜ê¸° ìœ„í•´ `*` ì‚¬ìš©
  - Index permissions :
    - crud : ê¸°ì¡´ ì„¤ì •
    - create_index : ê¸°ì¡´ ì„¤ì •
    - indices:admin/create : ë¡œê·¸ì— ì°íŒ ì—ëŸ¬ í•´ê²°ì„ ìœ„í•œ ê¶Œí•œ
    - indices:data/write/bulk* : ë¡œê·¸ì— ì°íŒ ì—ëŸ¬ í•´ê²°ì„ ìœ„í•œ ê¶Œí•œ
    - indices:admin/mapping/put : mapping ìƒì„±ì„ í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ ì¶”ê°€
    - indices:data/write/index : ì¸ë±ìŠ¤ ì‘ì„± ê¶Œí•œ ì¶”ê°€

`create` í•˜ê³  ë‚˜ë©´ ìƒì„±ëœ ì—­í• ì— ëŒ€í•œ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ `Mapped users` ì„ íƒí•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ í™”ë©´ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/d38a5e7e-9088-4298-a7d6-203c65deb6b4)

ì—¬ê¸°ì„œ `Manage mapping`ì„ ì„ íƒí•˜ë©´ ëœ¨ëŠ” í˜ì´ì§€ì˜ `Backend roles`ì— `logstash`ë¥¼ ì…ë ¥í•´ ë„£ìŠµë‹ˆë‹¤. `logstash`ë¡œ Backend roleì„ ì§€ì •í•œ ì´ìœ ëŠ”, ê¸°ì¡´ì˜ Backend roleì„ ì¬ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œì…ë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/beea6fcf-1760-4a78-a993-a7476456c3a9)

`Map`ì„ ëˆŒëŸ¬ Backend roleì„ ìƒì„±í•˜ì˜€ë‹¤ë©´, logstashë¥¼ ì¬ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
sudo systemctl restart logstash
```

ê·¸ ë‹¤ìŒ Kibanaì˜ `DevTools`ì— ì ‘ì†í•˜ì—¬ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ë´…ì‹œë‹¤.

```bash
GET _cat/indices?v
```

ê·¸ëŸ¬ë©´ `opendistrotest` ì¸ë±ìŠ¤ê°€ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/3faadeae-f373-4fc3-8d1c-89009f868eaa)

ì´ì²˜ëŸ¼ ê¶Œí•œ ë¬¸ì œë¡œ ì¸í•´ ì •ìƒ ë™ì‘í•˜ì§€ ì•ŠëŠ” ê²½ìš°, `Security` ë©”ë‰´ì—ì„œ ì„¤ì •ì„ ì¶”ê°€/ë³€ê²½í•˜ì—¬ í•´ê²°í•˜ë©´ ë©ë‹ˆë‹¤.

## 05. ì‚¬ìš©ìë³„ ë‹¤ë¥¸ ì¸ë±ìŠ¤ ì ‘ê·¼ ê¶Œí•œ ë¶€ì—¬í•˜ê¸°

ë¨¼ì € ìƒˆë¡œìš´ ì¸ë±ìŠ¤ë¥¼ í•˜ë‚˜ ë” ì¶”ê°€í•˜ê² ìŠµë‹ˆë‹¤. `main.conf` ë‚´ìš©ì„ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•œ ë‹¤ìŒ logstashë¥¼ `restart` í•©ë‹ˆë‹¤. ì°¸ê³ ë¡œ, í˜„ì¬ ì„¤ì •ì´ `sincedb_path => "/dev/null"`ì´ê¸°ì— ê¸°ì¡´ì— ì–´ë””ê¹Œì§€ log íŒŒì¼ì„ ì½ì—ˆëŠ”ì§€ ë”°ë¡œ ì €ì¥í•˜ì§€ ì•Šì•„ ê¸°ì¡´ì˜ `input.log` íŒŒì¼ ë‚´ìš©ì„ ì²˜ìŒë¶€í„° ì½ì–´ì˜¤ê²Œ ë˜ì–´ ìƒˆë¡œìš´ log íŒŒì¼ ìƒì„±ì„ í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤.

```bash
input {
  file {
    path => "/etc/logstash/test/input.log"
		start_position => "beginning"
		sincedb_path => "/dev/null"
	}
}

output {
  elasticsearch {
    hosts => ["http://10.0.0.1:9200", "http://10.0.0.2:9200", "http://10.0.0.3:9200", "http://10.0.0.4:9200", "http://10.0.0.5:9200"]
    index => "testindex" # ë³€ê²½ëœ ë¶€ë¶„
    user => "logstash"
    password => "logstash_password"
    ssl => true
    cacert => "/etc/logstash/root-ca.pem" 
  }
}
```

`opendistrotest` `testindex` ë¼ëŠ” ë‘ ê°œì˜ ì¸ë±ìŠ¤ ì¤€ë¹„ë¥¼ ì™„ë£Œí•˜ì˜€ìœ¼ë©´, ìƒˆë¡œìš´ ì‚¬ìš©ìë¥¼ ì¶”ê°€í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.
ë‘ ëª…ì˜ ì‚¬ìš©ìë¥¼ ì¶”ê°€í•  ì˜ˆì •ì´ë©°, `testuser1`ì€ `opendistrotest` ì¸ë±ìŠ¤ì—ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆê³ , `testuser2`ëŠ” `testindex`ì—ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ ìƒì„±í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

ë¨¼ì € ì‚¬ìš©ì ìƒì„±ì„ ìœ„í•´ `Security > Internal users`ë¡œ ì´ë™í•˜ì—¬ `Create internal user`ë¥¼ í´ë¦­í•©ë‹ˆë‹¤.
ê·¸ëŸ¬ë©´ í‘œì¶œë˜ëŠ” ì‚¬ìš©ì ìƒì„± í˜ì´ì§€ê°€ í‘œì¶œë˜ë©°, ì•„ë˜ì™€ ê°™ì´ `Username`ê³¼ `Password`ë¥¼ ì±„ì›ë‹ˆë‹¤. ê·¸ë¦¬ê³  `Create` ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‚¬ìš©ìë¥¼ ìƒì„±í•©ë‹ˆë‹¤. `testuser1` ì‚¬ìš©ìì™€ `testuser2` ì‚¬ìš©ì ëª¨ë‘ ìƒì„±í•´ì£¼ì„¸ìš”.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/ceef917e-8384-4088-8ccf-5fe4d349c782)

ì‚¬ìš©ì ìƒì„±ì„ ì™„ë£Œí•˜ë©´, ê° ì‚¬ìš©ìê°€ ì–»ì„ ì—­í• ì— ëŒ€í•œ `tenant`ë¥¼ ë¨¼ì € ìƒì„±í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. `Security > Tenants`ë¡œ ì´ë™í•˜ê³  `Create tenant`ë¥¼ í´ë¦­í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ tenant ìƒì„± íŒì—…ì´ í‘œì¶œë˜ë©°, ë‹¤ìŒê³¼ ê°™ì´ ì›í•˜ëŠ” `Name`ì„ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/bcc5a3ea-0c98-4ba7-b3fa-d8b2b2dfb931)


ê·¸ ë‹¤ìŒ `Security > Roles`ë¡œ ì´ë™í•˜ì—¬ `Create role`ì„ í´ë¦­í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ ì—­í•  ìƒì„± í˜ì´ì§€ê°€ í‘œì¶œë˜ë©°, `Name`ì€ ì›í•˜ëŠ” ëŒ€ë¡œ ì„¤ì •í•˜ê³ , `Index permissions` ì„¤ì •ê³¼ `Tenant permissions` ì„¤ì •ì€ ì•„ë˜ì™€ ê°™ì´ ì¶”ê°€í•©ë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/3c8a208f-fa9d-4bb8-88e1-ccb202fbd19c)

ì €ëŠ” `opendistro_rw`ë¥¼ ì—­í•  ì´ë¦„ìœ¼ë¡œ ì§€ì •í•˜ì˜€ìœ¼ë©°, í•´ë‹¹ ì—­í• ì€ `opendistro`ë¡œ ì‹œì‘í•˜ëŠ” ì¸ë±ìŠ¤ì— ëŒ€í•´ ì½ê³  ì“°ê¸° ê¶Œí•œì„ ê°€ì§€ê³  ìˆê²Œ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.

`opendistro_rw` ì—­í• ì´ ìƒì„±ë˜ë©´, `Mapped users`ì—ì„œ `Manage mapping`ì„ ì„ íƒí•©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ ë‹¤ìŒê³¼ ê°™ì€ í˜ì´ì§€ê°€ ëœ¨ëŠ”ë°, ì—¬ê¸°ì„œ `Users`ì— `testuser1`ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/d4616071-5059-47bf-b260-e2dc90da21b2)

ê·¸ëŸ¬ê³  ë‚˜ì„œ `Map`ì„ í´ë¦­í•˜ë©´ `testuser1`ì€ `opendistro_rw` ì—­í• ì„ ê°€ì§€ê²Œ ë©ë‹ˆë‹¤.

`testuser2`ì—ê²Œ `testindex`ë¥¼ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ ë¶€ì—¬ë„ ì´ì™€ ê°™ì€ ë°©ë²•ìœ¼ë¡œ ì§„í–‰í•˜ë©´ ë©ë‹ˆë‹¤. ì €ëŠ” `test_rw`ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì—­í• ì„ ìƒì„±í•˜ì˜€ìœ¼ë©°, `testuser2`ë¥¼ ì—°ê²°í•˜ì˜€ìŠµë‹ˆë‹¤.

Kibana ëŒ€ì‹œë³´ë“œì— `testuser1` ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸ì„ í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì´ tenantë¥¼ ì„ íƒí•˜ëŠ” í™”ë©´ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ `custom` tenantë¥¼ `opendistro`ë¡œ ì„ íƒí•˜ì—¬ ì ‘ì†í•´ë³´ê² ìŠµë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/f3ae2720-9357-428a-a35a-a4a3abee3c14)

ê·¸ ë‹¤ìŒ Kibana ë©”ë‰´ì˜ Dashboardë‚˜ Discoverë¡œ ì ‘ì†í•˜ë ¤ê³  í•  ë•Œ, ë‹¤ìŒê³¼ ê°™ì´ `index pattern`ì„ ìƒì„±í•˜ë¼ëŠ” ë¬¸êµ¬ë¥¼ ë³´ê²Œ ë©ë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/ec4c1cb8-a7b2-4b0f-8102-3a89b45898bc)

í˜ì´ì§€ í•˜ë‹¨ì— ë³´ë©´ ì•„ì£¼ ì‘ì€ ê¸€ì”¨ë¡œ `create an index pattern`ì´ ì¡´ì¬í•©ë‹ˆë‹¤. 

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/ef970b7e-5c1f-4302-81e4-529c664b7863)

ì´ ë¬¸êµ¬ë¥¼ í´ë¦­í•˜ë©´, `Create index pattern` í˜ì´ì§€ë¡œ ì´ë™í•˜ê²Œ ë©ë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/22928d10-64e0-447d-b326-5bf7d79b5de2)

`opendistro_rw` ì—­í• ì„ ìƒì„±í•  ë•Œ ì„¤ì •í–ˆë˜ ì¸ë±ìŠ¤ íŒ¨í„´ì„ ë™ì¼í•˜ê²Œ ì…ë ¥í•´ì£¼ë©´, í•´ë‹¹í•˜ëŠ” ì¸ë±ìŠ¤ê°€ ì–´ë–¤ ê²ƒì´ ìˆëŠ”ì§€ í™”ë©´ì— í‘œì‹œë©ë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/94be8de5-4156-48bf-bc21-6e4316f4af88)

`Next step >`ì„ ëˆ„ë¥´ë©´, `Time field`ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì›í•˜ëŠ” ëŒ€ë¡œ ì„¤ì •í•œ ë‹¤ìŒ `Create index pattern`ì„ í´ë¦­í•˜ë©´ ì¸ë±ìŠ¤ íŒ¨í„´ì´ ìƒì„±ë©ë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/2583a7b1-892a-4bbf-98a3-aeb33f1ca058)

ë‹¤ì‹œ `Kibana > Discover`ì— ì ‘ì†í•´ë³´ë©´, ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì¶œë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/fb6f3432-d699-43dc-8da4-f3b0549dc91b)

OpenDistroë¥¼ ì„¤ì •í•˜ë©´ì„œ ê°€ì¥ ë†€ëë˜ ì ì€ Search Guardì™€ êµ‰ì¥íˆ ìœ ì‚¬í•˜ë‹¤ëŠ” ì ì´ì—ˆìŠµë‹ˆë‹¤. Search Guard ì„¤ì •ì„ í•œ ë²ˆ í•´ë³´ì•„ì„œ ê·¸ëŸ°ì§€, OpenDistroë¥¼ ì„¤ì •í•˜ëŠ” ê²ƒì€ Search Guardë¥¼ ì²˜ìŒ ì„¤ì •í•  ë•Œë³´ë‹¤ ìˆ˜ì›”í•˜ê²Œ ì§„í–‰í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ì•„ì§ x-packì„ ì§ì ‘ ì ìš©í•´ë³´ì§€ëŠ” ì•Šì•˜ì§€ë§Œ, ê³µì‹ ë¬¸ì„œë¥¼ ê°€ë³ê²Œ ì‚´í´ë³´ì•˜ì„ ë•Œ êµ‰ì¥íˆ ìœ ì‚¬í•˜ê²Œ ì„¤ì •í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. í•˜ë‚˜ë§Œì´ë¼ë„ ì„¤ì • ê²½í—˜ì„ í•´ë³´ëŠ” ê²ƒì€ ë‚˜ì¤‘ì— ë‹¤ë¥¸ Security í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì •í•  ë•Œ ë§ì€ ë„ì›€ì´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤. ğŸ˜ŠğŸ˜Š

---

### ì°¸ê³ 
- <https://opendistro.github.io/for-elasticsearch-docs/>
- <https://opendistro.github.io/for-elasticsearch-docs/docs/security/configuration/generate-certificates/>
- <https://www.sslcert.co.kr/guides/kb/56?page=2>
- <https://github.com/opensearch-project/security/releases/tag/v1.13.1.0>
- <https://opensearch.org/docs/1.3/install-and-configure/plugins/#install>
- <https://opendistro.github.io/for-elasticsearch-docs/docs/security/configuration/tls/>
- <https://opensearch.org/docs/1.3/security/configuration/configuration/>
- <https://opensearch.org/docs/1.3/security/configuration/yaml>
- <https://opensearch.org/docs/1.3/security/access-control/api/>
- <https://nantech.tistory.com/13>
- <https://opensearch.org/docs/1.3/security/configuration/security-admin/>
- <https://opensearch.org/docs/1.3/dashboards/install/plugins/>
- <https://forum.opensearch.org/t/troubleshooting-security-plugin-issues/1234/22>
- <https://opendistro.github.io/for-elasticsearch-docs/docs/security/access-control/multi-tenancy/>
- <https://forum.opensearch.org/t/customizing-the-kibana-login-page/3697/4>
- <https://opendistro.github.io/for-elasticsearch-docs/docs/security/access-control/users-roles/#sample-roles>
