# 010. ElastAlert2 설정하기

[ElastAlert2](https://github.com/jertel/elastalert2)는 Yelp에서 만든 [ElastAlert](https://github.com/Yelp/elastalert)을 기반으로 발전한 오픈소스입니다. 더 이상 ElastAlert은 관리되지 않기에 ElastAlert2를 사용해야 합니다. 이와 관련하여 ElastAlert 공식 Github에서도 다음과 같이 기재해두었습니다.

> ElastAlert is no longer maintained. Please use ElastAlert2 instead.

ElastAlert2는 도커를 통해서도 설치가 가능한데, 여기서는 `Python Package`를 이용하여 설치하는 방법으로 진행하겠습니다. 다른 설치 방법은 [공식 문서](https://elastalert2.readthedocs.io/en/latest/running_elastalert.html#)를 참고해주세요.

## 00. 실습환경

- CentOS 7.9
- Python 3.11
- OpenSSL 1.1.1
- ElastAlert2 2.13.2

## 01. 파이썬 설치

ElastAlert2를 사용하기 위해서는 `Python 3.11` 이상의 버전이 필요합니다.
현재 설치된 버전을 아래 명령어로 확인해주세요.

```bash
python3 --version
# or
python3 -V
```

만약 설치가 되어있지 않거나 `Python 3.11` 보다 낮은 버전인 경우, python을 설치해야 합니다. 여기서는 설치하는 과정을 진행하도록 하겠습니다.

먼저 CentOS를 업데이트 합니다.

```bash
sudo yum -y update
```

업데이트를 완료하면 서버를 재부팅해주세요.

```bash
sudo systemctl reboot
```

재부팅이 되면 `Python 3.11`을 설치하기 위한 패키지를 설치합니다. `CentOS 7 / RHEL 7`의 경우 `Python 3.11`을 공식적으로 지원하지 않아 소스 코드를 직접 설치해야 하는데 이 때 아래의 패키지가 필요하기 때문입니다. 이미 설치가 되어 있다면 `Noting to do`라는 문구가 화면에 표출됩니다.

```bash
sudo yum -y install epel-release
sudo yum install -y wget make cmake gcc bzip2-devel libffi-devel zlib-devel
```

그 다음으로 `Python 3.11`을 빌드하기 위해 필요한 `OpenSSL 1.1.1`를 설치하도록 하겠습니다. 참고로, `OpenSSL 1.1.1` 이상의 버전이면 어떤 버전이든 괜찮습니다.

설치 전 먼저 현재 `openssl`이 존재하는지 확인해주세요.

```bash
openssl version
```

현재 설치된 버전이 `OpenSSL 1.1.1` 이상의 버전이 아니라면 제거합니다.

```bash
sudo yum -y remove openssl openssl-devel
```

그 다음 OpenSSL 설치에 필요한 패키지를 추가로 설치합니다.

```bash
sudo yum install -y gcc-c++ pcre-devel perl
```

패키지 설치가 완료되면, 아래 명령어를 통해 압축 파일을 다운로드 받거나 [공식 문서](https://www.openssl.org/source/)에서 직접 다운로드 받아 서버로 업로드 합니다.

```bash
wget https://www.openssl.org/source/openssl-1.1.1v.tar.gz
```

다운로드가 완료되면 압축을 해제합니다.

```bash
tar xvf openssl-1.1.1v.tar.gz
```

그 다음 생성된 디렉터리로 이동(`cd openssl-1.1.1v`) 후 `OpenSSL`을 설정합니다.

```bash
./config --prefix=/usr/local/openssl --openssldir=/usr/local/openssl
```

설정이 완료되면 아래 명령어를 통해 `OpenSSL 1.1.1` 버전을 빌드합니다.

```bash
make -j $(nproc)
```

이제 `OpenSSL 1.1.1`을 설치할 수 있습니다. 아래 명령어를 통해 설치해 주세요.

```bash
sudo make install
```

설치가 완료되면 공유 라이브러리 캐시를 업데이트 합니다.

```bash
sudo ldconfig
```

그 다음 시스템 전체 OpenSSL 설정을 업데이트 합니다.

```bash
sudo tee /etc/profile.d/openssl.sh<<EOF
export PATH=/usr/local/openssl/bin:\$PATH
export LD_LIBRARY_PATH=/usr/local/openssl/lib:\$LD_LIBRARY_PATH
EOF
```

업데이트가 완료되면 쉘 환경을 리로드합니다.

```bash
source /etc/profile.d/openssl.sh
```

서버를 `logout` 했다가 다시 접속하여 `OpenSSL` 버전을 확인하면, `1.1.1`로 설정된 것을 확인할 수 있습니다.

```bash
openssl version
# 아래와 같이 화면에 표출됨
# OpenSSL 1.1.1v  1 Aug 2023
```

이제 `Python 3.11` 설치를 위한 준비가 끝났습니다. 아래 명령어를 이용해서 `Python 3.11` 설치용 압축 파일을 다운로드 받거나 [공식 문서](https://www.python.org/downloads/)에서 직접 다운로드 받아 서버로 업로드 합니다.

```bash
wget https://www.python.org/ftp/python/3.11.4/Python-3.11.4.tgz
```

다운로드가 완료되면 압축을 해제합니다.

```bash
tar xvf Python-3.11.4.tgz
```

그 다음 생성된 디렉터리로 이동(`cd Python-3.11.4`) 후 아래 명령어를 통해 설정합니다.

```bash
LDFLAGS="${LDFLAGS} -Wl,-rpath=/usr/local/openssl/lib" ./configure --with-openssl=/usr/local/openssl 
```

설정이 완료되면 빌드해주세요. 빌드하는 데 조금 걸릴 수 있습니다.

```bash
make
```

빌드가 완료되었다면, 이제 `Python 3.11`을 설치할 수 있습니다. 아래 명령어를 통해 설치해 주세요.

```bash
sudo make altinstall
```

설치가 완료되면 다음 명령어를 통해 버전이 뜨는지 확인해주세요.

```bash
python3.11 --version
# or
python3.11 -V
```

그리고 설치 과정에서 `pip`도 함께 설치됩니다. `pip`도 `python`과 마찬가지로 `--version` 또는 `-V`를 통해 버전 확인이 가능합니다.

```bash
pip3.11 --version
# or
pip3.11 -V
```

## 02. ElastAlert2 설치

ElastAlert2를 설치하기 전, Python 모듈을 업데이트 합니다.

```bash
pip3.11 install "setuptools>=11.3"
```

pip 업그레이드도 진행해주세요.

```bash
pip3.11 install --upgrade pip
```

그 다음 [공식 Github](https://github.com/jertel/elastalert2/releases)에서 필요한 버전을 다운로드 받습니다. 저는 `$HOME`에 `elastalert2` 디렉터리를 생성하고 그 안에 다운로드 받았습니다. 참고로, `git clone`을 통해 받으시는 방법도 있습니다.

다운로드가 완료되면 압축을 해제합니다.

```bash
tar xvf elastalert2-2.13.2.tar.gz
```

압축 해제가 완료되면, 생성된 디렉터리(`elastalert2-2.13.2`)로 이동합니다. 
그리고 ElastAlert을 설치하기 위해 필요한 모듈을 먼저 설치합니다.

```bash
pip3.11 install -r requirements.txt
```

그 다음 `setup.py`의 `install_requires` 내에 있는 모듈 설정을 모두 주석 처리합니다. 이렇게 하는 이유는 `install_requires`의 모듈은 기본적으로 `pip`를 통해 설치되기 때문입니다. 그러나 여기서는 `pip3.11`로 실행해야 하기 때문에 이러한 과정이 필요합니다. ~~이러한 과정이 싫다면 pip 실행 시 pip3.11이 실행되도록 변경하면 됩니다.~~

```python

import os

from setuptools import find_packages
from setuptools import setup

base_dir = os.path.dirname(__file__)
setup(
    # 내용 생략
    install_requires=[
       # 'apscheduler>=3.9.1.post1,<4.0',
       # 'aws-requests-auth>=0.4.3',
       # 'boto3>=1.26.30',
       # 'cffi>=1.15.1',
       # 'croniter>=1.3.8',
       # 'elasticsearch==7.10.1',
       # 'envparse>=0.2.0',
       # 'exotel==0.1.5',
       # 'Jinja2>=3.1.2',
       # 'jira>=3.4.1',
       # 'jsonpointer>=2.3',
       # 'jsonschema>=4.17.3',
       # 'prison>=0.2.1',
       # 'prometheus_client>=0.15.0',
       # 'python-dateutil>=2.8.2',
       # 'PyYAML>=6.0',
       # 'py-zabbix>=1.1.7',
       # 'requests>=2.8.2',
       # 'sortedcontainers>=2.4.0',
       # 'statsd-tags==3.2.1.post1',
       # 'stomp.py>=8.1.0',
       # 'tencentcloud-sdk-python>=3.0.795',
       # 'texttable>=1.6.7',
       # 'twilio>=7.16.0',
       # 'tzlocal==2.1'
    ]
)
```

만약 이렇게 하지 않고 `setup.py`를 설치하면 다음과 같은 에러가 발생하게 됩니다.

```bash
Download error on https://pypi.org/simple/: [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1002) -- Some packages may not be found!
```

모듈 설치가 완료되면, 아래 명령어를 사용하여 `ElastAlert2`를 설치합니다.

```bash
sudo python3.11 setup.py install
```

그 다음 ElastAlert이 동작하는데 필요한 Elasticsearch 인덱스를 생성하면 설치가 끝납니다. 만약 여러 대의 Elastsearch Cluster를 바라보고 있는 ElastAlert 서버가 여러 대라면, **ElastAlert 한 대에서만 진행**해주세요.

```bash
elastalert-create-index
```

그리고 Elastsearch 1대에 대한 host, port 정보와 username, password 정보를 입력합니다. 만약 `index` 이름을 따로 설정하고 싶다면 원하는 대로 입력해주세요. 여기서는 `elastalert`으로 설정했습니다. 설정하지 않으면 `elastalert_status`라고 저장됩니다.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/cceaf11c-4d0c-4fc0-90b4-22009ebed62e)

생성이 완료되었는지는 Kibana DevTools에서 확인해보겠습니다.

```bash
GET _cat/indices/elastalert*?v&s=index:desc
```

Kibana DevTools에 위와 같이 입력하고 실행하면, 다음과 같은 내용을 확인할 수 있습니다.

```
health status index              uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   elastalert_status  rnVmB4KzSOuORgnZn5v9Vg   1   1          0            0       416b           208b
green  open   elastalert_silence wQ5tzi49TKG0EFtrae_ESQ   1   1          0            0       416b           208b
green  open   elastalert_past    JCYlZdA2SCmcIeY_sPdHJQ   1   1          0            0       416b           208b
green  open   elastalert_error   KH8xpGLDSdWnME13limEQQ   1   1          0            0       416b           208b
green  open   elastalert         PlfHTmXrRuOX3bDtSuvKAA   1   1          0            0       416b           208b
```

## 03. ElastAlert 설정

ElastAlert 설치가 완료되었으므로, 이제 실행을 위한 설정을 진행하도록 하겠습니다. 먼저, 설정 파일인 `config.yml`과 규칙을 저장할 `rules` 디렉터리를 생성합니다. 여기서는 `elastalert2` 디렉터리 위치에 생성했으며, 구조는 다음과 같습니다.

```text
elastalert2
├── config.yaml
├── elastalert2-2.13.2
└── rules
```

그 다음 `config.yaml`을 아래와 같이 작성합니다. 

```yaml
rules_folder: rules
run_every:
  seconds: 10
buffer_time:
  minutes: 15
es_host: 10.0.0.1
es_port: 9200
es_username: admin
es_password: admin1!@
es_hosts:
    - 10.0.0.1:9200
    - 10.0.0.2:9200
    - 10.0.0.3:9200
    - 10.0.0.4:9200
    - 10.0.0.5:9200
writeback_index: elastalert
```

- `rules_folder` : 규칙 파일이 위치한 디렉터리 경로
- `run_every` : 규칙을 리로드하는 시간 간격 (default `minutes: 5`)
- `buffer_time` : 지정한 시간 범위 내에서 이벤트나 패턴을 역추적하고 알림을 생성하기 위해 사용되는 설정
- `es_hosts` : ElastSearch 목록
- `verify_certs` : TLS 인증서 검증 여부 설정 (default `True`)
- `es_host` : Elasticsearch IP
- `es_port` : Elasticsearch Port
- `es_username` : Elasticsearch 사용자 이름
- `es_password` : Elasticsearch 사용자 비밀번호
- `es_hosts` : Elasticsearch 클러스터 목록
- `writeback_index` : ElastAlert2가 데이터를 저장할 인덱스 이름




---

### 참고
- <https://github.com/Yelp/elastalert>
- <https://github.com/jertel/elastalert2>
- <https://elastalert2.readthedocs.io/en/latest/running_elastalert.html#as-a-python-package>
- <https://computingforgeeks.com/install-python-3-on-centos-rhel-7/>
- <https://computingforgeeks.com/how-to-install-openssl-1-1-on-centos-rhel-7/#google_vignette>
- <https://freewings.tistory.com/81>
- <https://www.unh4ck.com/building-an-open-siem-from-scratch/3.-installing-elastalert>