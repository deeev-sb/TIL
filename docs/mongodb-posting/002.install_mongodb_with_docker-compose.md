# 002. docker-composeë¡œ mongodb ì„¤ì¹˜í•˜ê¸°

## MongoDB ì„¤ì¹˜

`docker-compose.yml`ì„ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•©ë‹ˆë‹¤.

```yaml
version: '3.8'

services:
  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: master
      MONGO_INITDB_ROOT_PASSWORD: master
    volumes:
      - mongo_data:/data/db

volumes:
  mongo_data:
    driver: local
```

ê·¸ë‹¤ìŒ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ `docker-compose`ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
docekr-compose up -d
```

ê·¸ëŸ¬ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì¹˜ ë° ì‹¤í–‰ëœ ëª¨ìŠµì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<img width="285" alt="image" src="https://github.com/user-attachments/assets/a1d05410-c513-4d7e-acf3-1e1fb75d5307">

ì •ìƒì ìœ¼ë¡œ ë„ì›Œì§„ ìƒíƒœì¸ì§€ í™•ì¸í•˜ë ¤ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

```bash
docker-compose ps
```

<img width="1069" alt="image" src="https://github.com/user-attachments/assets/8812f7f1-3bfe-482f-bc1b-18f5702bf603">

ê·¸ë‹¤ìŒ docker í„°ë¯¸ë„ì— ì ‘ì†í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•´ë³´ë©´?!
ì•„ë§ˆ ì ‘ì†ì´ ì•ˆë˜ì‹¤ê±°ì—ìš”... ğŸ˜‚

```bash
docker exec -it mongodb mongo -u master -p master --authenticationDatabase admin
```

ì €ëŠ” ì ‘ì†ì´ ì•ˆë˜ê³  ì•„ë˜ì™€ ê°™ì€ ë¬¸êµ¬ë§Œ ëœ¨ë”ë¼ê³ ìš”.

```
OCI runtime exec failed: exec failed: unable to start container process: exec: "mongo": executable file not found in $PATH: unknown
```

ì´ëŸ¬í•œ ë¬¸ì œëŠ” MongoDB 4.2 ë²„ì „ë¶€í„°ëŠ” `mongosh`ë¥¼ ì‚¬ìš©í•˜ì—¬ shellì— ì ‘ê·¼í•˜ê¸° ë•Œë¬¸ì— ë°œìƒí•©ë‹ˆë‹¤. ëª…ë ¹ì–´ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë°”ê¿”ì£¼ë©´ ë°”ë¡œ ì ‘ì†í•˜ì‹¤ ìˆ˜ ìˆìœ¼ì‹¤ ê±°ì—ìš”.

```bash
docker exec -it mongodb mongosh -u master -p master --authenticationDatabase admin
```

<img width="1096" alt="image" src="https://github.com/user-attachments/assets/af6c0d83-3dbe-4e02-8f94-9d65e0968f50">

ì‚¬ì‹¤ ì´ˆê¸°í™”ë¥¼ í•  ë•ŒëŠ” `docker exec -it mongodb mongosh`ë¼ê³  ì…ë ¥í•´ë„ ë¬´ê´€í•˜ë‹¤ê³  í•˜ëŠ”ë°, ì „ í™•ì‹¤í•˜ê²Œ username, password, ì—°ê²° db ì„¤ì •í•˜ê³  ì‹¶ì–´ì„œ ë‹¤ ì…ë ¥í–ˆì–´ìš”.

mongo shellì— ì ‘ì†ë˜ì—ˆìœ¼ë‹ˆ, db ì„¤ì •ì„ í•´ì•¼ í•©ë‹ˆë‹¤. ê³„ì • ì •ë³´ëŠ” ëª¨ë‘ `admin` dbì— ì €ì¥í•˜ë¯€ë¡œ dbë¥¼ ë³€ê²½í•´ì¤ë‹ˆë‹¤.

```bash
use admin
```

í˜„ì¬ `master` ê³„ì •ì˜ ì„¤ì •ì€ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
db.getUser('master')
```

ì‹¤ì œë¡œ ë³¼ ìˆ˜ ìˆëŠ” ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

<img width="407" alt="image" src="https://github.com/user-attachments/assets/bb41febe-4ac2-4b49-9261-98d028e86972">

init ê³„ì •ì´ê¸°ì— ìë™ìœ¼ë¡œ `root` ê¶Œí•œì„ ë¶€ì—¬ ë°›ì•˜ìœ¼ë‚˜, admin dbì— ëŒ€í•œ ê¶Œí•œë§Œ ì •ì˜ëœ ìƒíƒœì…ë‹ˆë‹¤.
ì´ ìƒíƒœì¸ ê³„ì •ì„ spring í”„ë¡œì íŠ¸ì— ì—°ë™í•˜ê³  Create APIë¥¼ ë§Œë“¤ì–´ ì‹¤í–‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ë¥¼ ë§Œë‚˜ê²Œ ë©ë‹ˆë‹¤.

```
2024-11-16T13:44:02.163+09:00 ERROR 94169 --- [fan-signal-api] [      Thread-11] b.f.exception.GlobalExceptionHandler     : Exception occurred: Exception authenticating MongoCredential{mechanism=SCRAM-SHA-1, userName='master', source='fan-signal', password=<hidden>, mechanismProperties=<hidden>}
```

ì‚¬ìš©í•˜ë ¤ëŠ” DBì¸ `fan-signal`ì— ëŒ€í•œ ê¶Œí•œì„ ì£¼ì–´ì•¼ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ê²Œ ë©ë‹ˆë‹¤.
ì‹¤ì œë¡œ ì‚¬ìš©í•˜ë ¤ëŠ” DBëª…ì„ ì…ë ¥í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.

```bash
db.grantRolesToUser("master", [{ role: "readWrite", db: "fan-singal" }])
```

ê·¸ë‹¤ìŒ ì¡°íšŒí•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ fan-signal dbì— ëŒ€í•œ ê¶Œí•œì´ ìƒê¸´ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<img width="588" alt="image" src="https://github.com/user-attachments/assets/b32135d0-7647-4951-84ae-09cc2e418594">




## ì°¸ê³ 
- https://www.sktenterprise.com/bizInsight/blogDetail/dev/2652
- https://github.com/docker-library/mongo/issues/558
- https://www.mongodb.com/ko-kr/docs/mongodb-shell/install/
- https://www.mongodb.com/ko-kr/docs/manual/tutorial/manage-users-and-roles/
- https://www.mongodb.com/ko-kr/docs/manual/reference/method/js-user-management/