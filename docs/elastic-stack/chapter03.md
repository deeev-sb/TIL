# 03. 엘라스틱서치 기본

::: tip ✅ 실습 환경

- Elasticsearch 7.10.2  
- Kibana 7.10.2

:::

## 3.1. 준비 작업

### 3.1.1. 엘라스틱서치 요청과 응답
엘라스틱서치는 **모든 요청과 응답을 REST API 형태로 제공**합니다.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/34e36450-2ef1-4f73-9c54-66b771d97846)

REST란 `Representational State Transfer'의 약자로, 웹 상의 모든 리소스에 URI를 부여하고 활용하는 아키텍처입니다. REST는 다음과 같은 디자인 원칙을 가집니다.
1. 균일한 인터페이스
    - 요청이 어디에서 오는지와 무관하게, 동일한 리소스에 대한 모든 API 요청은 동일하게 보여야 함
    - 클라이언트가 필요로 하는 모든 정보를 포함해야 함
2. 클라이언트-서버 디커플링
    - REST API 디자이너에서 클라이언트와 서버 애플리케이션은 서로 간에 완전히 독립적이어야 함
3. Stateless (무상태)
    - 각 요청에서 처리에 필요한 모든 정보를 포함해야 함
4. 캐싱 가능성
    - 가능하면 리소스를 클라이언트나 서버에서 캐싱할 수 있어야 함
    - 서버 응답에 전달된 리소스에 대해 캐싱 허용 여부에 대한 정보가 포함되어야 함
5. 계층 구조 아키텍처
    - 호출과 응답이 서로 다른 계층을 통과함
6. 코드 온디맨드
    - 일반적으로 정적 리소스를 전송하지만, 특정 응답에 실행 코드를 포함할 수도 있음

REST API는 이러한 REST 아키텍처 스타일의 디자인 원칙을 준수하는 API 입니다. REST API는 다음과 같은 네 가지 메소드 타입을 가지고 리소스의 CRUD(생성/조회/수정/삭제) 작업을 진항하며, URI는 리소스를 명시하는 방법입니다.

|메소드|설명|
|:---:|:---|
|POST|리소스 추가|
|GET|리소스 조회|
|PUT|리소스 수정|
|DELETE|리소스 삭제|

### 3.1.2. 키바나 콘솔 사용법

`Management > Dev Tools`를 선택하면 키바나 콘솔 화면으로 이동됩니다.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/1b341697-cc67-40c9-858b-404029178569)

키바나 콘솔을 이용하면 복잡한 앱 개발이나 프로그램 설치 없이 엘라스틱서치와 REST API로 통신할 수 있습니다. 키바나 콘솔은 엘라스틱서치 API 자동 완성 기능도 지원하며, 문법이 올바른지 구문 검사도 해주기 때문에 입력 오류로 인한 불필요한 시간 낭비도 막아줍니다.

### 3.1.3. 시스템 상태 확인

`cat API`를 사용하면 엘라스틱서치의 현재 상태를 빠르게 확인할 수 있습니다. 여기서 cat은 'compact and aligned text'의 약어이며, 콘솔에서 시스템 상태를 확인할 때 가독성을 높일 목적으로 만들어진 API 입니다.

`GET _cat`을 요청하면 cat API가 지원하는 목록을 확인할 수 있습니다.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/a2aacf31-e009-49cf-9a62-14b306c1bc1c)

위 이미지를 통해 알 수 있듯이, cat API를 통해 노드, 샤드, 템플릿 등의 상태 정보나 통계 정보를 확인할 수 있습니다.

예를 들어, 아래와 같은 명령어를 입력하면 클러스터 내부 인덱스 목록을 확인할 수 있습니다.

```bash
GET _cat/indices?v
```

`?` 기호 뒤에는 붙은 `v`는 파라미터이며, v (verbose) 파라미터를 사용하면 컬럼의 이름을 확인할 수 있습니다. v 외에도 정렬 옵션인 s (sort) 파라미터, 설정한 열만 표시하는 h (header) 파라미터 등이 있습니다. cat API에 대한 더 자세한 내용이 궁금하시다면 [공식 문서](https://www.elastic.co/guide/en/elasticsearch/reference/7.10/cat.html)를 참고하시길 바랍니다.

확인된 결과는 다음과 같습니다.

```bash
health status index     uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana_1 PGiP7ED9RYqaQ4WwNOQSHA   1   1         41           14     99.1kb         44.7kb
```

## 3.2. 인덱스와 도큐먼트
엘라스틱서치는 다음과 같이 클러스터(cluster), 인덱스(index)와 도큐먼트(document), 필드(field)로 구성되어 있습니다.

![image](https://github.com/Kim-SuBin/TIL/assets/46712693/d27fa8f4-af1c-44bd-8b69-77dfa0fa57bd)

엘라스틱서치를 이해하기 위해서는 인덱스와 도큐먼트가 무척 중요합니다. 지금부터 인덱스와 도큐먼트에 대해 조금 더 자세하게 알아보도록 하겠습니다.

### 3.2.1. 도큐먼트

도큐먼트에 대해 정리하면 다음과 같습니다.
- 엘라스틱서치에서 데이터가 저장되는 기본 단위
- JSON 형태
- 하나의 도큐먼트는 여러 필드(field)와 값(value)을 가짐
- 인덱스 내부에 생성됨

RDB를 알고 있다면 아래 표를 통해 더 직관적으로 이해될 것입니다.

|RDB|엘라스틱서치|
|:---:|:---:|
|테이블|인덱스|
|레코드|도큐먼트|
|컬럼|필드|
|스키마|매핑|

참고로, 엘라스틱서치 7.x 이전 버전에는 타입(type)이라는 개념이 존재했습니다. 그러나 여기서는 7.10.2 버전을 통해 사용하기 때문에 타입이 존재하지 않으므로, 관련 설명은 생략하도록 하겠습니다.

### 3.2.2. 인덱스

인덱스에 대해 정리하면 다음과 같습니다.

- 도큐먼트를 저장하는 논리적 단위
- 하나의 인덱스에 다수의 도큐먼트가 포함되는 구조
- 클러스터 내부에 생성됨
- 인덱스 이름에는 영어 소문자와 \, /, *, ?, ", <, >, |, #, 공백, 쉼표 등을 제외한 특수문자를 사용할 수 있으며, 255 바이트를 넘을 수 없음

인덱스 그룹핑 방법은 다음과 같이 2가지입니다.

1. 스키마에 따른 그룹핑
    - 스키마에 따라 인덱스를 구분한다.<br/>e.g. 회원 정보 인덱스, 장바구니 인덱스
    - 인덱스 스키마는 매핑을 통해 정의한다.
2. 관리 목적의 그룹핑
    - 성능을 위해 인덱스 용량을 제한해야 한다.<br/>인덱스는 용량이나 숫자 제한 없이 무한대의 도큐먼트를 포함할 수 있는데, 인덱스가 커지면 검색 시 많은 도큐먼트를 참조해야 하기 때문에 성능이 나빠질 수 있다.
    - 주로 도큐먼트 개수, 용량, 날짜/시간 단위로 분리한다.
    - 날짜/시간 단위로 분리하면 특정 날짜의 데이터를 쉽게 처리할 수 있다.<br/>e.g. 1개월 지난 데이터 모두 삭제

## 3.3. 도큐먼트 CRUD

### 3.3.1. 인덱스 생성/확인/삭제

도큐먼트는 반드시 하나의 인덱스에 포함되어야 하기 때문에, 도큐먼트 CRUD에 대해 알아보기 전 인덱스를 생성/확인/삭제하는 방법을 알아보도록 하겠습니다. 실습은 키바나 콘솔에서 진행하도록 하겠습니다.

1. 인덱스 생성하기

```bash
PUT {인덱스명}
# 예제
PUT index1
```

2. 인덱스 확인하기

```bash
GET {인덱스명}
# 예제
GET index1
```

3. 인덱스 삭제하기

```bash
DELETE {인덱스명}
# 예제
DELETE index1
```

**인덱스를 삭제하면 인덱스에 저장되어 있는 모든 도큐먼트가 삭제되므로 주의**해야 합니다.

### 3.3.2. 도큐먼트 생성

도큐먼트를 인덱스에 포함시키는 것을 **인덱싱(indexing)** 이라고 합니다. 아래 명령어를 통해 도큐먼트를 인덱싱해봅시다.

```bash
PUT index2/_doc/1
{
    "name" : "mike",
    "age" : 25,
    "gender" : "male"
}
```

명령어를 실행하면 기존에 존재하지 않던 index2 인덱스가 생성됨과 동시에 index2에 도큐먼트를 인덱싱합니다. 명령어의 각 내용을 살펴보면 다음과 같습니다.

- index2 : 인덱스 이름
- _doc : 엔드포인트 구분을 위한 예약어
- 1 : 인덱싱할 도큐먼트 고유 아이디
- name, age, gender : 필드

index2가 정상적으로 생성되었는지 조회해봅시다.

```bash
GET index2
```

명령어를 실행하면 다음과 같이 각 데이터 타입이 자동으로 지정된 것을 확인할 수 있습니다.

```json
{
  "index2" : {
    "aliases" : { },
    "mappings" : {
      "properties" : {
        "age" : {
          "type" : "long"
        },
        "gender" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "name" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        }
      }
    },
    // ...
  }
}
```
또한, 새로운 필드를 추가하고 기존 필드 일부를 생략해도 인덱싱은 정상 동작합니다.

```bash
PUT index2/_doc/2
{
    "name" : "jane",
    "country" : "france"
}
```

그리고 데이터 타입을 잘못 입력한 경우에는 엘라스틱서치에서 알아서 형변환을 해줍니다.

```bash
PUT index2/_doc/3
{
    "name" : "luna",
    "age" : "20"
}
```

이렇게 엘라스틱서치는 데이터 타입을 지정하지 않아도 도큐먼트의 필드와 값을 보고 자동으로 데이터 타입을 지정해주는 것을 다이나믹 매핑(dynamic mapping)이라고 하며, 관련 내용은 뒤에서 더 자세하게 다루도록 하겠습니다.

### 3.3.3. 도큐먼트 읽기
도큐먼트를 읽는 방법은 크게 두 가지입니다.

1. 도큐먼트 아이디를 이용해 조회하는 방법

```bash
GET index2/_doc/1
```

도큐먼트 아이디를 이용해 조회하면, 명령어 내 도큐먼트 아이디를 가진 도큐먼트 하나만을 가져옵니다.

2. 쿼리 DSL (Domain Specific Language)를 이용해 검색하는 방법

```bash
GET index2/_search
```

쿼리 DSL을 사용한 위 명령어는 index2 인덱스 내의 모든 도큐먼트를 가져옵니다.

### 3.3.4. 도큐먼트 수정

**PUT**을 사용한 도큐먼트 인덱싱 과정에서 같은 도큐먼트 아이디가 있으면 **덮어쓰기** 됩니다.

```bash
PUT index2/_doc/1
{
    "name" : "park",
    "age" : 45,
    "gender" : "male"
}
```

위의 수정 명령어 실행 후 `GET index/_doc/1` 명령어를 실행하면 정상적으로 덮어쓰기가 된 것을 확인할 수 있습니다.

```json
{
  "_index" : "index2",
  "_type" : "_doc",
  "_id" : "1",
  // ...
  "_source" : {
    "name" : "park",
    "age" : 45,
    "gender" : "male"
  }
}
```

PUT은 무조건 덮어쓰기 때문에 도큐먼트 내용 중 일부만 업데이트를 하려고 해도, 수정할 내용을 포함한 모든 도큐먼트 내용을 입력해야 합니다. 만약 1번 도큐먼트의 이름과 나이만 변경하려고 할 때, 다음과 같이 입력하면 gender 정보가 사라지는지 확인해봅시다.

```bash
PUT index2/_doc/1
{
    "name" : "kim",
    "age" : 25
}
```

`GET index/_doc/1` 명령어를 실행하면 정상적으로 덮어쓰기되어 gender가 사라진 것을 확인할 수 있습니다.

```json
{
  "_index" : "index2",
  "_type" : "_doc",
  "_id" : "1",
  // ...
  "_source" : {
    "name" : "kim",
    "age" : 25
  }
}
```

**일부 필드만 업데이트**하고 싶다면 **update API**를 사용하면 됩니다.

```bash
POST index2/_update/1
{
    "doc" : {
      "name" : "lee"
    }
}
```

`GET index/_doc/1` 명령어를 실행하면 name만 변경되고 나머지 데이터는 그대로 존재하는 것을 확인할 수 있습니다.

```json
{
  "_index" : "index2",
  "_type" : "_doc",
  "_id" : "1",
  // ...
  "_source" : {
    "name" : "lee",
    "age" : 25
  }
}
```

그러나 엘라스틱서치 도큐먼트 수정 작업은 비용이 많이 들기 때문에 권장하지 않습니다. 수정 작업이 많다면, 다른 데이터베이스를 이용하는 것이 좋습니다.

### 3.3.5. 도큐먼트 삭제

다음과 같이 `DELETE {인덱스 이름}/_doc/{도큐먼트 아이디}`로 명령어를 실행하면, 도큐먼트 아이디에 해당하는 도큐먼트가 삭제됩니다.

```bash
DELETE index2/_doc/2
```

수정과 마찬가지로 삭제 작업은 비용이 많이 들기 때문에 사용 시 주의해야 합니다.

## 3.4. 응답 메시지

엘라스틱서치 REST API 응답 코드는 다음과 같습니다.

|코드|상태|해결 방법|
|:---:|:---|:---|
|200, 201|정상 수행||
|4xx|클라이언트 오류|클라이언트에서 문제 수정|
|404|요청한 리소스가 없음|인덱스나 도큐먼트가 존재하는지 체크|
|405|요청 메소드(GET, POST 등)을 지원하지 않음|API 사용법 다시 확인|
|429|요청 과부화(busy)|재전송, 노드 추가 같은 조치|
|5xx|서버 오류|엘라스틱서치 로그 확인 후 조치|

아직 만들어지지 않은 index5라는 이름을 가진 인덱스를 조회하여 어떻게 응답되는지 살펴봅시다.

```bash
GET index5
```

`status`로 404를 반환하며, 오류 원인을 `reason`에 상세히 설명해주는 것을 확인할 수 있습니다.

```json
{
  "error" : {
    "root_cause" : [
      {
        "type" : "index_not_found_exception",
        "reason" : "no such index [index5]",
        "resource.type" : "index_or_alias",
        "resource.id" : "index5",
        "index_uuid" : "_na_",
        "index" : "index5"
      }
    ],
    "type" : "index_not_found_exception",
    "reason" : "no such index [index5]",
    "resource.type" : "index_or_alias",
    "resource.id" : "index5",
    "index_uuid" : "_na_",
    "index" : "index5"
  },
  "status" : 404
}
```

엘라스틱서치는 여러 개의 API를 한 번에 수행할 수 있는 `bulk API`를 지원하며, bulk API를 통해 REST API 콜(call) 횟수를 줄여 성능을 높일 수 있습니다.

> 본 게시글은 [엘라스틱 스택 개발부터 운영까지](https://product.kyobobook.co.kr/detail/S000001932755) 도서를 참고하여 작성되었습니다.
>
> 상세한 내용이 궁금하시다면 책을 읽어보실 것을 추천해 드립니다.
>

추가로 참고한 내용
- <https://www.ibm.com/kr-ko/topics/rest-apis>
- <https://www.elastic.co/guide/en/elasticsearch/reference/7.10/cat.html>
