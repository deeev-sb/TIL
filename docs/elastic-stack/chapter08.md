# 08. 키바나

::: tip ✅ 실습 환경

- Elasticsearch 7.10.2
- Kibana 7.10.2

:::

## 8.1. 키바나 소개

키바나의 기능은 다음과 같이 세 가지로 분류할 수 있습니다.

| 기능            | 설명                             |
|:--------------|:-------------------------------|
| 데이터 분석과 시각화 툴 | 오플소스 기반의 데이터 탐색 및 시각화 도구 제공    |
| 엘라스틱 관리       | 보안, 스냅샷, 인덱스 관리, 개발자 도구 등을 제공  |
| 엘라스틱 중앙 허브    | 모니터링을 비롯해 엘라스틱 솔루션을 탐색하기 위한 포털 |

그 중 **데이터 분석과 시각화 기능을 중점으로 소개** 할 예정입니다.

키바나는 아래 그림과 같이 시스템의 끝단에서 사용자에게 정보를 효율적으로 제공합니다.
엘라스틱서치에서 제공되는 시계열 데이터나 위치 분석 같은 다양한 분석 결과를 키바나를 통해 시각화 할 수 있습니다.

<img width="383" alt="image" src="https://github.com/Kim-SuBin/TIL/assets/46712693/90c1b37b-4a7b-4604-9baa-ae4cc8399559">

키바나의 대표적인 시각화 기능은 다음과 같습니다.

| 시각화 기능           | 설명                                        |
|:-----------------|:------------------------------------------|
| 디스커버 (Discover)  | 데이터를 도큐먼트 단위로 탐색해 구조와 관계 등을 확인할 수 있다.     |
| 시각화 (Visualize)  | 다양한 그래프 타입으로 데이터 시각화를 할 수 있다.             |
| 대시보드 (Dashboard) | 그래프, 지도 등을 한 곳에서 확인하면서 다양한 인사이트를 얻을 수 있다. |
| 캔버스 (Canvas)     | 그래프와 이미지 등을 프레젠테이션 슬라이드처럼 구성할 수 있다.       |
| 맵스 (Maps)        | 위치 기반 데이터를 지도 위에 표현할 수 있다.                |

시각화와 관련된 키바나의 특징은 다음과 같습니다.

- 시각화를 하기 위해서는 **반드시 엘라스틱서치 인덱스에 연결**되어야 함
- 범용적인 시각화 툴로 사용하기에는 무리
- 다양한 그래프와 지도를 지원
- 빅데이터 처리 가능

### 8.1.1. 인덱스 패턴

키바나는 데이터 소스를 엘라스틱서치 인덱스에서 가져오는데, 이를 **인덱스 패턴 (Index patterns)** 이라고 합니다.
키바나 인덱스 패턴은 엘라스틱서치의 인덱스 매핑 정보 등을 키바나에 사용하기 적합하게 **미리 캐싱해둔 것**으로, 여러 개의 인덱스에 대한 메타 데이터를 병합해 저장해뒀다가 검색이나 시각화 생성 시 활용합니다.

예를 들면, 아래 그림과 같이 `syslog-*`이라는 키바나 인덱스 패턴은 엘라스틱서치 인덱스 중 `syslog-*₩ 인덱스 패턴에 접근해 쿼리 및 시각화를 합니다.

<img width="313" alt="image" src="https://github.com/Kim-SuBin/TIL/assets/46712693/233a14f4-f68d-4d95-b619-55f1b53d4ba3">

키바나에서 바로 엘라스틱서치 인덱스에 **직접 접근하지 않고 인덱스 패턴이라는 구조를 한 단계 더 거치는 것일까요?**

인덱스 패턴을 만드는 이유는 **복수 인덱스에 대한 매핑을 사전에 병합**해두어 쿼리 생성이나 시각화에 활용할 수 있기 때문입니다.

키바나에서 직접 인덱스 패턴을 생성해봅시다. 우선, 키바나 Dev Tools에서 아래와 같이 인덱스를 추가해줍니다.

```bash
PUT kibana_index1/_doc/1
{
  "name": "kim"
}

PUT kibana_index2/_doc/1
{
  "name": "lee"
}
```

그 다음 메뉴에서 `Management > Stack Management`에 접속하여 `Kibana > Index Patterns`를 선택합니다. 그러면 아래와 같은 이미지를 볼 수 있습니다.

<img width="800" alt="image" src="https://github.com/Kim-SuBin/TIL/assets/46712693/cee6d99d-05f6-4654-b49c-a99adf23b463">

화면에서 `Create index pattern` 버튼을 클릭합니다. 그러면 아래와 같은 화면이 뜨는데, 중간의 빈 칸에 `kibana_index*`와 같이 **인덱스 패턴명**을 입력합니다.
인덱스 패턴명에는 와일드카드(*)와 쉼표(,)를 사용해 복수의 패턴을 포함할 수 있고, 패턴 앞에 마이너스(-) 기호를 붙여 특정 패턴을 제외할 수도 있습니다.

<img width="800" alt="image" src="https://github.com/Kim-SuBin/TIL/assets/46712693/15b7b3ba-94d7-4ac6-b166-563d0172b342">

`Next step` 버튼 클릭 후 뜨는 화면에서 `Create index pattern`을 클릭하면 인덱스 패턴이 생성됩니다.

<img width="800" alt="image" src="https://github.com/Kim-SuBin/TIL/assets/46712693/b7d8217f-cc34-4072-97d9-e5c3d03769c8">

## 8.2. 디스커버

실습을 하기 전 엘라스틱에서 제공하는 샘플 데이터 3개를 로드해주세요. 샘플 데이터를 로드하면 인덱스 생성과 동시에 인덱스 패턴을 만들어줍니다. 샘플 데이터 로드는 이전에 살펴보았기 때문에 설명을 생략하겠습니다.

가장 먼저 디스커버(`Discover`)에 대해 알아보겠습니다. 메뉴에서 `Kibana > Discover`를 클릭하면 아래와 같은 화면을 확인할 수 있습니다.
이렇듯 디스커버는 문서/이벤트/도큐먼트/로그의 시간에 따른 발생량을 히스토그램으로 보여주며, 데이터 구조나 필드 등을 간단히 확인할 수 있습니다.
그렇기에 주로 **데이터를 확인하고 탐색하기 위한 용도로 사용**합니다.

<img width="743" alt="image" src="https://github.com/Kim-SuBin/TIL/assets/46712693/3632a27c-0fa7-43c8-ba67-b0b109cfa6d8">

디스커버 화면을 구성하는 각 인터페이스들의 설명은 아래와 같습니다.

| 번호  | 인터페이스       | 설명                                                   |
|:---:|:------------|:-----------------------------------------------------|
|  1  | 툴바          | 결과를 저장하고 불러오는 등 기능 버튼 위치                             |
|  2  | 인덱스 패턴      | 탐색할 인덱스 패턴을 선택할 수 있음                                 |
|  3  | 사이드바        | 필드 타입과 필드명을 볼 수 있어 데이터 구조 확인 가능. 특정 필드만 선택도 가능함      |
|  4  | 시계열 히스토그램   | 시간에 따른 발생량 확인 가능. 인덱스 패턴에 시간/날짜 필드가 없는 경우 아무것도 표출 안함 |
|  5  | 쿼리바         | 쿼리를 이용해 데이터 검색을 할 수 있음                               |
|  6  | 타임피커        | 시계열 데이터의 시간 범위 조정 기능                                 |
|  7  | 필터바         | 쿼리를 필터처럼 사용 가능                                       |

### 8.2.1. 쿼리바, 필더바, 타임피커

쿼리바와 필더바, 타임피커는 Discover 외 다른 메뉴에서도 쓰이며, 잘 사용하면 **데이터를 쉽게 조작하고 탐색**할 수 있습니다.
단, **쿼리바와 필더바는 상호 보완적인 관계**임을 명시합시다. 그리고 타임피커는 인덱스 패턴에 타임 필드를 지정한 경우에만 사용할 수 있습니다.

#### 8.2.1.1. 쿼리바

쿼리바는 **KQL(Kibana Query Language)과 루씬 쿼리 스트링**, 두 가지 언어를 지원합니다. 특별한 설정이 없으면 쿼리바는 기본적으로 KQL 언어를 이용합니다.
쿼리바는 다음과 같이 **자동완성 기능**을 제공하여 손쉽게 쿼리를 구현할 수 있습니다.

<img width="1014" alt="image" src="https://github.com/Kim-SuBin/TIL/assets/46712693/45be6d77-176c-4d6e-9c35-fe75e7c835e8">

#### 8.2.1.2. 필터바

필터바는 **필드를 개별적으로 처리**할 수 있습니다. `Add filter`를 클릭하고 다음과 같이 `Field`와 `Operator`, `Value`를 설정하면 됩니다.
필터바 역시 **자동완성 기능을 지원**하며, `Edit as Query DSL` 링크를 이용해 복잡한 쿼리도 설정할 수 있습니다.

<img width="371" alt="image" src="https://github.com/Kim-SuBin/TIL/assets/46712693/e157b528-f3b6-42f1-83e4-19c9bc459446">

설정된 필터를 클릭하면 아래 이미지와 같은 메뉴가 뜹니다.

<img width="243" alt="image" src="https://github.com/Kim-SuBin/TIL/assets/46712693/dd6d13be-d38e-465b-b160-b1ae0447f113">

메뉴의 `Pin across all apps`를 선택하면, 그 필터는 **모든 앱(대시보드, 시각화 등)에 적용**됩니다.
그리고 `Temporarily disable`은 **일시적으로 필터를 비활성화**하며, 다시 활성화하려면 `Re-enable`을 선택하면 됩니다.

#### 8.2.1.3. 타임피커

타임피커는 **날짜/시간 정보를 조작해 데이터를 특정 날짜/시간 범위 내에서 시각화**합니다. 키바나 인덱스 패턴을 생성할 때, **기본 날짜/시간 필드를 설정**해야 사용할 수 있습니다.

아이콘을 누르면 다음과 같이 `Commonly used`와 `Recently used date ranges` 그리고 `Refresh every`를 볼 수 있습니다.
여기서 `Refresh every`를 `Stop`하지 않으면 계속 데이터를 불러오기 때문에, 특정 데이터에 대해 상세히 확인하고 싶다면 `Stop`으로 설정해야 합니다.

<img width="387" alt="image" src="https://github.com/Kim-SuBin/TIL/assets/46712693/e6857f03-46f9-4e43-ab0d-ad5ce04c7b59">

날짜와 시간을 직접 설정하려면, 아래와 같이 날짜 위치를 클릭하면 됩니다. 이 때, 설정을 변경하면 `Update` 버튼을 클릭해야 적용됩니다.

<img width="541" alt="image" src="https://github.com/Kim-SuBin/TIL/assets/46712693/37378b3c-4eb5-4c5b-b3c9-fa957c4c1359">

## 8.3. 시각화

시각화(Visualize)는 **엘라스틱서치에 저장된 데이터를 그래프나 표, 지도 등 다양한 타입으로 보여주는 역할**을 합니다.
라인, 바, 파이 차트, 맵 등 **다양한 시각화 타입을 지원**합니다. 시각화 타입은 대부분 메트릭 집계와 버킷 집계를 통해 그래프를 그리고, 복잡한 그래프는 파이프라인 집계를 이용합니다.

메트릭 집계, 버킷 집계, 파이프라인 집계는 앞에서 설명하기에 간략하게 짚고 넘어가도록 하겠습니다.

- 메트릭 집계 : 평균/최소/최대 같은 수량 계산
- 버킷 집계 : 특정 기준에 맞춰 데이터 분리. 서브 버킷 생성 가능
- 파이프라인 집계 : 집계 결과를 입력으로 받아 다시 집계를 함. 부모/형제 집계 유형이 있음



> 본 게시글은 [엘라스틱 스택 개발부터 운영까지](https://product.kyobobook.co.kr/detail/S000001932755) 도서를 참고하여 작성되었습니다.
>
> 상세한 내용이 궁금하시다면 책을 읽어보실 것을 추천해 드립니다.
>
