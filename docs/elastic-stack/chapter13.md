# 13. 클러스터와 노드 구성

일반적으로 클러스터는 여러 대의 컴퓨터를 병렬로 연결해 하나의 시스템을 구상하는 것을 말하며, 이렇게 구성하면 고가용성을 높이는 동시에 시스템 성능도 높일 수 있습니다.
엘라스틱서치에서는 클러스터를 구성하는 요소를 **노드(node)** 라고 하며, **클러스터는 여러 노드의 집합**이 됩니다.
그리고 노드는 엘라스틱서치가 설치되는 물리적 혹은 논리적 단위입니다.

지금부터 노드, 클러스터 그리고 샤드에 대해 알아보도록 하겠습니다.

## 13.1. 노드의 통신 모듈

노드의 통신 모듈은 두 가지로, 클러스터 내부에서 사용하는 **전송(transport) 모듈**과 외부와의 통신에 사용하는 **HTTP 모듈**이 있습니다.

<img width="335" alt="image" src="https://github.com/Kim-SuBin/TIL/assets/46712693/24448d39-e1c6-4313-9fa5-c127f77a0743">

통신 모듈에 대한 특징은 다음과 같습니다.

- 전송 모듈
  - 클러스터 내부 모듈 간의 통신에 사용
  - 노드 간 데이터를 분산 처리하는 구조에 적합한 방식
  - 기본 포트 : 9300 ~ 9399
- HTTP 모듈
  - 엘라스틱 API에서 제공하는 형태로 외부 클라이언트 앱과 통신 시 사용
  - 기본 포트 : 9200 ~ 9299

## 13.2. 노드

노드는 **엘라스틱서치 클러스터를 구성하는 하나의 인스턴스**이며, 데이터를 저장하고 클러스터의 인덱싱과 검색 기능에 참여합니다.
**물리적인 서버 하나에 노드 하나를 구성하는 방식을 권장**하지만, 단일 서버에 복수의 노드를 설치할 수도 있습니다.
클러스터에 참여하는 **노드 이름은 중복돼서는 안 되며**, 하나의 노드가 여러 역할을 할 수도 있습니다.
엘라스틱서치에서 제공하는 노드들의 역할을 알아보겠습니다.

### 13.2.1. 마스터 노드

클러스터는 **반드시 하나의 마스터 노드(master node)를 가져야 합니다.** 마스터 노드가 없으면 클러스터가 멈추기 때문입니다.
마스터 노드는 인덱스의 설정, 매핑 정보와 물리적 위치, 클러스터 설정 정보, 인덱스 템플릿 정보 등 **클러스터의 모든 상태 정보를 관리**합니다.
또한 각 노드들과 통신하며 **클러스터의 변화를 모니터링**합니다.

마스터 노드는 사용자가 지정할 수 없으며 **다수의 마스터 후보 노드가 투표를 통해 결정**합니다.
사용자는 마스터 후보 노드(master-eligible node)만 지정할 수 있습니다.

#### 13.2.1.1. 마스터 노드 선출 과정

클러스터 내 마스터 후보 노드들은 **투표를 통해 마스터 노드를 선출**합니다.
다음과 같이 마스터 후보로 지정된 노드만이 투표 권한을 가집니다.
그렇기에 노드4는 마스터를 투표할 수도 마스터가 될 수도 없습니다.
마스터 후보인 노드1, 노드2, 노드3만 투표가 가능하며, 마스터도 이 셋 중 하나로 결정됩니다.

<img width="363" alt="image" src="https://github.com/deeev-sb/TIL/assets/46712693/2c029842-dc17-49c9-9b15-095962a2494a">

과반수에 의해 노드1이 마스터 후보가 되었다고 가정하겠습니다.
이 때, 기존의 마스터 노드인 노드1이 클러스터에서 이탈한다면 **마스터 노드를 재선출하는 과정**이 필요하게 됩니다.
마스터 노드 재선출 때도 마찬가지로 **마스터 후보 노드만 투표**할 수 있습니다.

<img width="310" alt="image" src="https://github.com/deeev-sb/TIL/assets/46712693/c4f69eff-58b7-4a92-9e49-572426e789a5">

노드2와 노드3 중 노드3이 마스터 노드가 되고 난 이후 노드1이 다시 클러스터에 합려를 하면 어떻게 될까요?
**이미 마스터 노드 선출이 완료**된 상황이기 때문에, 노드1이 복귀하더라도 다시 선출하는 상황은 발생하지 않습니다.

<img width="310" alt="image" src="https://github.com/deeev-sb/TIL/assets/46712693/8a08b8ec-0d15-4bfe-8eb8-e3d34bd234d4">

#### 13.2.1.2. 스플릿 브레인

스플릿 브레인(split brain)은 네트워크 장애 등으로 클러스터가 분리되었을 때 나누어진 각각의 서브 클러스터가 서로 마스터 노드를 선출하고 **독립적인 클러스터로 동작하는 상태**를 의미합니다.
이렇게 되면 **2개의 독립적인 클러스터에서 각각 요청을 처리**하기 때문에 추후 시스템이 합쳐질 때 **동기화 문제**가 발생합니다.



> 본 게시글은 [엘라스틱 스택 개발부터 운영까지](https://product.kyobobook.co.kr/detail/S000001932755) 도서를 참고하여 작성되었습니다.
>
> 상세한 내용이 궁금하시다면 책을 읽어보실 것을 추천해 드립니다.
>

